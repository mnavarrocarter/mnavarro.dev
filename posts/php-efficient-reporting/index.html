<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#282A36"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><title>Efficient Reports in PHP - mnavarro.dev</title><meta name=description content="Leverage the power of unbuffered TCP connections and PHP Generators to do reporting well"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"mnavarro.dev","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/mnavarro.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/mnavarro.dev\/posts\/php-efficient-reporting\/","name":"Efficient reports in p h p"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Efficient Reports in PHP","description":"When it comes to reporting, I have a predefined set of rules that I follow sacredly and that will ensure that my report writing experience will be nice and problem-free.\n","inLanguage":"en","wordCount":1512,"datePublished":"2019-12-10T11:18:48","dateModified":"2019-12-10T11:18:48","image":"https:\/\/mnavarro.dev\/","keywords":["php, reporting, generators, mysql, pdo"],"mainEntityOfPage":"https:\/\/mnavarro.dev\/posts\/php-efficient-reporting\/","publisher":{"@type":"Organization","name":"https:\/\/mnavarro.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/mnavarro.dev\/","height":60,"width":60}}}</script><meta property="og:title" content="Efficient Reports in PHP"><meta property="og:description" content="Leverage the power of unbuffered TCP connections and PHP Generators to do reporting well"><meta property="og:url" content="https://mnavarro.dev/posts/php-efficient-reporting/"><meta property="og:type" content="website"><meta property="og:site_name" content="mnavarro.dev"><meta name=twitter:title content="Efficient Reports in PHP"><meta name=twitter:description content="Leverage the power of unbuffered TCP connections and PHP Generators to do reporting well"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.71.0"><link rel=alternate href=https://mnavarro.dev/index.xml type=application/rss+xml title=mnavarro.dev><link rel=stylesheet href=https://mnavarro.dev/css/style.css><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap" as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap"></noscript><link rel=preload href=https://mnavarro.dev/css/syntax.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://mnavarro.dev/css/syntax.css></noscript><script async defer data-domain=mnavarro.dev src=https://mnavarro.dev/stats.js></script></head><body><header><div class=wrapper><p class="site-brand muted lambda terminal"><a href=https://mnavarro.dev/>mnavarro.dev</a></p><nav><ul><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/about>About</a></li><li><a title=Media href=/media>Media</a></li><li><a title="Atom Feed" href=/index.xml>Rss</a></li></ul></nav></div></header><main><div class=wrapper><article><h1 class=post-title>Efficient Reports in PHP</h1><p class=small>10 December 2019
| 8 minutes read
| 1512 words</p><div class=content><p>When it comes to reporting, I have a predefined set of rules that I follow sacredly and that will ensure that my report writing experience will be nice and problem-free.</p><ol><li>Do not use ORMs</li><li>Use non-buffered TCP connections</li><li>Use PHP generators with abstractions</li><li>Prefer easy-to-stream content types</li></ol><p>There you have! My promise is that if you follow these simple four rules, your report writing experience will be much more pleasant and your application will work on them more efficiently. Let&rsquo;s review these rules one by one:</p><h2 id=1-do-not-use-orms>1. Do not use ORMs</h2><p>ORMs, as indicated in the meaning of their acronym, have a very specific purpose. That purpose is to map relational database tables to the objects that contain our business logic. This is so we can abstract away persistence details and focus in expressing our domain in code. But a report is neither a domain action or a business rule. It&rsquo;s just a report: some business guy wants to see data on an spreadsheet.</p><p>Anything we use the ORM for that is not related to the purpose stated above constitutes a wrong use of the ORM. ORMs were designed for nothing else than domain objects mapping.</p><p>If I load the ORM with ten thousand rows worth of database records, I&rsquo;m not going to even reach a thousand before my script runs out of memory. This is because most ORMs have a in-memory cache of some sort, and also because objects consume more memory than more simpler data types, like hash maps or arrays. Some terrible things I&rsquo;ve seen developers do to solve this is to increase the default memory limit of the application (worst idea ever) or to clear the memory cache of the Entity Manager every X iterations (not that bad, but still not the right thing to do).</p><p>Even when you can get around the memory issue, you still are putting your system under a lot of stress because of all the mapping logic. Just stop there and ask yourself the question &ldquo;Do I really need hydrated objects for this?&rdquo; You&rsquo;ll find that the answer is, in 99% of cases, no.</p><p>This is really all you need.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>UserReporter</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>activeUsers</span><span class=p>()</span><span class=o>:</span> <span class=nx>iterable</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>inactiveUsers</span><span class=p>()</span><span class=o>:</span> <span class=nx>iterable</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>You don&rsquo;t need anything more complex than this. Implement it in PDO or any other database library, perform the necessary translations/normalizations, and return an iterable of some sort. You&rsquo;ll be amazed of how easy and efficient this approach is.</p><h2 id=2-use-non-buffered-tcp-connections>2. Use non-buffered TCP connections</h2><p>TCP connections are slow (this compared to writing in the host&rsquo;s filesystem, for example). So almost every database client that I know uses something that is called buffering. In PDO, for example, this works by accumulating the resultset of a query in the database memory, and once is done, flush it all to the client requesting the data over the TCP socket. This means that in PHP, every time you are querying something, your are loading the whole result in memory.</p><p>Now, depending of the size of your table, this may also kill your application. If your table is 5 GB and you are dumping all its records into a csv file, that is going to allocate 5 Gb in your app&rsquo;s memory. I remember the first time I encountered this problem working for a client. They had a database with the amount in MW of the electricity generated by every single electrical generation plant in Chile, every hour, over the span of 5 years. In Chile there are around 150 electrical generation plants and there are 8760 hours in a year, so that table had close to 6.127.000 records, each record roughly weighing 1 kb. That sole table was around 6 GB. Of course that wen I tried to allocate that much memory into my system it was going to crash.</p><p>Reports like this can easily kill your app if you are not cautious. In cases like this, is always good to buffer the results as they happen over the TCP connection. In PDO, you can do this by disabling buffering in queries:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=nv>$pdo</span><span class=o>-&gt;</span><span class=na>setAttribute</span><span class=p>(</span><span class=nx>PDO</span><span class=o>::</span><span class=na>MYSQL_ATTR_USE_BUFFERED_QUERY</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</code></pre></div><p>Then you iterate over your resultset and you will get every record as it is found, keeping your memory usage very low at the cost of less speed and a bit more CPU.</p><p>You can read more about non-buffered queries in PDO <a href=https://phpdelusions.net/pdo#mysqlnd>here</a></p><h2 id=3-use-php-generators-with-abstractions>3. Use PHP generators with abstractions</h2><p>Is of little use if you disable buffering your query to put every result into an array and continue with it. What you want here is the power of generators.</p><p>I&rsquo;m not going to explain in detail what they are. For that you can read <a href=https://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html>the amazing blog post that Nikita Popov wrote about them</a>. I&rsquo;m going to say that a generator is a special kind of iterator that yields the items of an iteration without necessarily know the whole iterable structure in advance.</p><p>They fit very well our case for the non-buffered queries in PDO, because we do not know the whole resultset in advance, so we can yield values as they reach our server.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>UserReporter</span> <span class=p>{</span>

    <span class=k>private</span> <span class=nx>PDO</span> <span class=nv>$pdo</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>PDO</span> <span class=nv>$pdo</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>pdo</span> <span class=o>=</span> <span class=nv>$pdo</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>activeUsers</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span> <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>pdo</span><span class=o>-&gt;</span><span class=na>setAttribute</span><span class=p>(</span><span class=nx>PDO</span><span class=o>::</span><span class=na>MYSQL_ATTR_USE_BUFFERED_QUERY</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
        <span class=nv>$stmt</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>pdo</span><span class=o>-&gt;</span><span class=na>prepare</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM `users` WHERE `status` = &#39;active&#39;&#34;</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$stmt</span><span class=o>-&gt;</span><span class=na>execute</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=nx>RuntimeException</span><span class=p>(</span><span class=s1>&#39;Query error&#39;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>while</span> <span class=p>(</span><span class=nv>$row</span> <span class=o>=</span> <span class=nv>$stmt</span><span class=o>-&gt;</span><span class=na>fetch</span><span class=p>(</span><span class=nx>PDO</span><span class=o>::</span><span class=na>FETCH_ASSOC</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>yield</span> <span class=nv>$row</span><span class=p>;</span> <span class=c1>// This is the keyword!!
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>When a function has the yield keyword inside it, their return value will be an <code>Iterator</code> (specifically, a <code>Generator</code> instance), and every iteration will return the next yielded value. So, when <code>Iterator::next()</code> is called, code will be executed until a yield is found, and that will be the return value. The code yielding will be paused until the <code>Iterator::next()</code> is called, and it will continue where it was the last time, until there are no more yields.</p><p>This is a powerful feature, useful to implement streams, data transformation pipelines and even coroutines (as Nikita&rsquo;s blog post shows). You can compose iterables over iterables to create cool pipelines and process your report data separating concerns effectively.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>UppercaseNames</span> <span class=k>implements</span> <span class=nx>IteratorAggregate</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>iterable</span> <span class=nv>$iterable</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>iterable</span> <span class=nv>$iterable</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>iterable</span> <span class=o>=</span> <span class=nv>$iterable</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>getIterator</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span>
    <span class=p>{</span>
        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>iterable</span> <span class=k>as</span> <span class=nv>$item</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Transform the data and then yield
</span><span class=c1></span>            <span class=k>yield</span> <span class=nv>$transformedItem</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>class</span> <span class=nc>NormalizeEmails</span> <span class=k>implements</span> <span class=nx>IteratorAggregate</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nv>$iterable</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>iterable</span> <span class=nv>$iterable</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>iterable</span> <span class=o>=</span> <span class=nv>$iterable</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>getIterator</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span>
    <span class=p>{</span>
        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>iterable</span> <span class=k>as</span> <span class=nv>$item</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Transform the data and then yield
</span><span class=c1></span>            <span class=k>yield</span> <span class=nv>$transformedItem</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>class</span> <span class=nc>TranslateFields</span> <span class=k>implements</span> <span class=nx>IteratorAggregate</span>
<span class=p>{</span>
     <span class=k>private</span> <span class=nv>$iterable</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>iterable</span> <span class=nv>$iterable</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>iterable</span> <span class=o>=</span> <span class=nv>$iterable</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>getIterator</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span>
    <span class=p>{</span>
        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>iterable</span> <span class=k>as</span> <span class=nv>$item</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Transform the data and then yield
</span><span class=c1></span>            <span class=k>yield</span> <span class=nv>$transformedItem</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=nv>$pipeline</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>UppercaseNames</span><span class=p>(</span><span class=k>new</span> <span class=nx>NormalizeEmails</span><span class=p>(</span><span class=k>new</span> <span class=nx>TranslateFields</span><span class=p>(</span><span class=nv>$userReporter</span><span class=o>-&gt;</span><span class=na>activeUsers</span><span class=p>())));</span>

<span class=k>foreach</span> <span class=p>(</span><span class=nv>$pipeline</span> <span class=k>as</span> <span class=nv>$item</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Write in a csv or something
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>Who needs ETL processing libraries when you have the power of Generators at your disposal? 🤓️</p><link rel=stylesheet href=https://mnavarro.dev/css/hugo-easy-gallery.css><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=https://media.giphy.com/media/11ahZZugJHrdLO/giphy-downsized.gif alt=https://media.giphy.com/media/11ahZZugJHrdLO/giphy-downsized.gif></div><a href=https://media.giphy.com/media/11ahZZugJHrdLO/giphy-downsized.gif itemprop=contentUrl></a><figcaption><h4>OMG generators are soo cool!</h4></figcaption></figure></div><h2 id=4-prefer-easy-to-stream-content-types>4. Prefer easy-to-stream content types</h2><p>One of the first things I ask when someone asks me to dump a report from a set of SQL tables is &ldquo;Can the report be a CSV?", most of the time the answer is an annoying no, because is too complex for the business guy to import a csv file into excel (really?). But I try to make my point anyways.</p><p>Every content type structured as a tree is hard to stream, specially in PHP. I&rsquo;m mainly talking about <code>xml</code> and <code>json</code> here. As you might know, an excel file is just compressed xml. Even really good libraries like <a href=https://opensource.box.com/spout/><code>box/spout</code></a> have to do some in-memory cache or temp file gymnastics to stream <code>.xlsx</code> files. Json files can be streamed as well, but not using the native json extension functions. For streaming json in PHP you should use <a href=https://github.com/violet-php/streaming-json-encoder><code>violet-php/streaming-json-encoder</code></a>. But the most simple of all formats is the beautiful csv. Just line by line streaming: forget about parsing and reading byte per byte.</p><p>The reason to prefer streams is because, potentially, you will be sending this somewhere else: be an object storage or a client over HTTP. Trust me, you want to stream that.</p><p>I&rsquo;ve seen applications that when I click &ldquo;Download Report&rdquo; it waits for like three whole minutes until the browser downloading tray icon pops, and then takes a second to download. This is because most reports build the file in-memory or disk, and then send it to the client when is done. This is poor UX. Let the user know at least that you are sending data to him/her by streaming the content, and not making him/her wait for three minutes.</p><h2 id=conclusion>Conclusion</h2><p>Writing reports is one of the most boring tasks of a developer, but happens to be one of the most common ones. Do it well, and you&rsquo;ll save yourself a lot of time that you can use in doing other, more interesting things. Besides, you&rsquo;ll learn a thing or two about streaming, generators and TCP connections. 🙂️</p></div><div class=post-terms><p class=small>Taggged
<a href=https://mnavarro.dev/tags/php/>php</a>,
<a href=https://mnavarro.dev/tags/reporting/>reporting</a>,
<a href=https://mnavarro.dev/tags/generators/>generators</a>,
<a href=https://mnavarro.dev/tags/mysql/>mysql</a>,
<a href=https://mnavarro.dev/tags/pdo/>pdo</a>,</p></div><div class=post-nav><div class=post-nav-prev><a href=https://mnavarro.dev/posts/semantic-versioning/>Entendiendo Versionamiento Semántico</a></div><div class=post-nav-next><a href=https://mnavarro.dev/posts/php-filesystem-unit-testing/>Unit-testing the filesystem in PHP</a></div></div></article><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mnavarro"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main><footer><div class=wrapper><p class=small>Last Modified:
2 July 2021</p><p class="muted lambda">Process exited with code <span id=status>0</span></p></div></footer></body></html>