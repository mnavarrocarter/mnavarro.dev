<!doctype html><html lang=en><head><title>Preventing tenant pollution in multitenant applications :: The Chilean Nerd</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.
One of those mistakes is what I&amp;rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something."><meta name=keywords content="chilean,blog,programming,matias,navarro,carter,php,programming,golang"><meta name=robots content="noodp"><link rel=canonical href=https://mnavarro.dev/posts/tenant-pollution/><link rel=stylesheet href=https://mnavarro.dev/assets/style.css><link rel=stylesheet href=https://mnavarro.dev/assets/blue.css><link rel=apple-touch-icon href=https://mnavarro.dev/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://mnavarro.dev/img/favicon/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mnavarrocarter"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Preventing tenant pollution in multitenant applications"><meta property="og:description" content="Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.
One of those mistakes is what I&amp;rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something."><meta property="og:url" content="https://mnavarro.dev/posts/tenant-pollution/"><meta property="og:site_name" content="The Chilean Nerd"><meta property="og:image" content="https://mnavarro.dev/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Tech"><meta property="article:published_time" content="2021-06-06 00:00:00 +0100 +0100"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>The Chilean Nerd</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/showcase>Showcase</a></li><li><a href=https://github.com/mnavarrocarter>Github</a></li><li><a href=/about>About</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>English ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://mnavarro.dev/>English</a></li><li><a href=https://mnavarro.dev/es/>Español</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/showcase>Showcase</a></li><li><a href=https://github.com/mnavarrocarter>Github</a></li><li><a href=/about>About</a></li><hr><li><a href=https://mnavarro.dev/>English</a></li><li><a href=https://mnavarro.dev/es/>Español</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://mnavarro.dev/posts/tenant-pollution/>Preventing tenant pollution in multitenant applications</a></h1><div class=post-meta><span class=post-date>2021-06-06</span></div><span class=post-tags>#<a href=https://mnavarro.dev/tags/php/>PHP</a>&nbsp;
#<a href=https://mnavarro.dev/tags/oop/>OOP</a>&nbsp;
#<a href=https://mnavarro.dev/tags/multitenancy/>Multitenancy</a>&nbsp;</span><div class=post-content><div><p>Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.</p><p>One of those mistakes is what I&rsquo;ve come to call <strong>tenant pollution</strong>. This means that many services or routines need the tenant as an argument in order to do something. This causes the tenant or the tenant unique identifier to be passed around many layers of the codebase. Basically, the tenant was <strong>everywhere</strong> in the code.</p><p>For example, this is a small part of our filesystem interface:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Filesystem</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>string</span> $tenantId, <span style=color:#a6e22e>string</span> $path, <span style=color:#a6e22e>StreamInterface</span> $contents)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>;

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>string</span> $tenantId, <span style=color:#a6e22e>string</span> $path)<span style=color:#f92672>:</span> <span style=color:#a6e22e>StreamInterface</span>;
}
</code></pre></div><p>The implementation contains a <code>TenantProvider</code> that can use the tenant id to retrieve information about the tenant and use that information to determine the folder name where all the tenant files should be stored.</p><p>All of our services are pretty much similar. Here is another example of the <code>EmailFactory</code>, that creates email messages.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>EmailFactory</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>string</span> $tenantId, <span style=color:#a6e22e>string</span> $messageName, <span style=color:#66d9ef>array</span> $data <span style=color:#f92672>=</span> [])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Email</span>;
}
</code></pre></div><p>The approach is pretty much similar to the filesystem one. We pass the tenant so we can fetch their settings. With the settings, we will created custom branded emails for our tenant with their corporate logos and images.</p><p>I have to say that when I was implementing all these services I sort of smelled this. Didn&rsquo;t liked it, but I preferred to the alternative of shared internal service state. And there is nothing I am more against than that. It is terrible OOP.</p><p>Many developers would do this. They will remove the tenant and pass it to a setter in the service.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConcreteEmailFactory</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setTenant</span>(<span style=color:#a6e22e>Tenant</span> $tenant)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>
    {
        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tenant</span> <span style=color:#f92672>=</span> $tenant;
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>string</span> $messageName, <span style=color:#66d9ef>array</span> $data <span style=color:#f92672>=</span> [])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Email</span>
    {
        <span style=color:#75715e>// Do the action.
</span><span style=color:#75715e></span>    }
}
</code></pre></div><p>But, once you set the tenant state you could run into all sorts of undesired side effects. PHP does not make this very obvious, due to the fact that when executed in CGI mode all the state is regenerated across requests. But when you are using React PHP or spinning workers in Road Runner, that&rsquo;s when it bites you. If you move to other languages you cannot and must not do this. PHP should not be the exception.</p><p>But I sort of had a realization when working in the frontend with React and other frameworks. You see, state in frontend is everywhere. Everything is side-effecty and built around state. Frontend developers live with this reality all the time. It teaches them not to <em>fear</em> state, but to tame it and manage it properly. This is the reason why React&rsquo;s <code>useEffect</code> hook exists.</p><p>I asked myself. Okay, shared state stored in a service is bad but, is there a way in which I could control it, or tame it?</p><p>I said, first, let&rsquo;s acknowledge it&rsquo;s existence in an interface:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TenantState</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>Tenant</span> $tenant)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>;
}
</code></pre></div><p>Now, how can unset that initialized state so I avoid side effects? Like <code>useState</code> in React works: I will return a <code>callable</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TenantState</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>Tenant</span> $tenant)<span style=color:#f92672>:</span> <span style=color:#a6e22e>callable</span>;
}
</code></pre></div><p>This is how it would look in the email factory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConcreteEmailFactory</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>Tenant</span> $tenant)<span style=color:#f92672>:</span> <span style=color:#a6e22e>callable</span>
    {
        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tenant</span> <span style=color:#f92672>=</span> $tenant;
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span> () {
            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tenant</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
        };
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>string</span> $messageName, <span style=color:#66d9ef>array</span> $data <span style=color:#f92672>=</span> [])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Email</span>
    {
        <span style=color:#75715e>// Do the action.
</span><span style=color:#75715e></span>    }
}
</code></pre></div><p>The secret is this: when executed, the callable will leave the class in it&rsquo;s original state. Now, you can group a bunch of these services into a composite initializer and have a single place in your code where you will initialize all the tenant state, group the callables to unset the state, and then return them.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CompositeTenantState</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>TenantState</span>
{
    <span style=color:#e6db74>/** @param TenantState[] $states **/</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>array</span> $states;

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct(<span style=color:#a6e22e>TenantState</span> <span style=color:#f92672>...</span>$states)
    {
        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>states</span> <span style=color:#f92672>=</span> $states;
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>Tenant</span> $tenant)<span style=color:#f92672>:</span> <span style=color:#a6e22e>callable</span>
    {
        $unsets <span style=color:#f92672>=</span> [];

        <span style=color:#66d9ef>foreach</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>states</span> <span style=color:#66d9ef>as</span> $state) {
            $unsets[] <span style=color:#f92672>=</span> $state<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>initialize</span>($tenant);
        }

        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span> () <span style=color:#66d9ef>use</span> ($unsets) {
            <span style=color:#66d9ef>foreach</span> ($unsets <span style=color:#66d9ef>as</span> $unset) {
                $unset();
            } 
        };
    }
}
</code></pre></div><p>You implement <code>TenantState</code> in every service that needs the tenant, and you pass it to this composite implementation.</p><p>This approach is great. If you are using middleware, you can initialize all the tenant state early in the pipeline, and then, when the request has finished, you unset all the state you have set. It is useful also for centralizing initialization of many services at once, so if you need to run the same logic in a console command, you can set up all the services for a tenant and use them freely.</p><p>I wish I could have done this since the beginning. Object graphs would be simpler and methods shorter. Well, I guess you never cease to learn.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mnavarro.dev/posts/when-to-use-interfaces/><span class=button__icon>←</span>
<span class=button__text>When to use Interfaces</span></a></span>
<span class="button next"><a href=https://mnavarro.dev/posts/advice-junior-project-saboteurs/><span class=button__text>Advice for junior project saboteurs</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>©2019 Matias Navarro Carter. CC-BY-SA.</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://mnavarro.dev/assets/main.js></script><script src=https://mnavarro.dev/assets/prism.js></script><script src=https://mnavarro.dev/assets/languageSelector.js></script></div></body></html>