<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#282A36"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><title>Unit-testing the filesystem in PHP - mnavarro.dev</title><meta name=description content="Efficiently testing PHP's native filesystem functions without hitting a real filesystem"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"mnavarro.dev","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/mnavarro.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/mnavarro.dev\/posts\/php-filesystem-unit-testing\/","name":"Unit testing the filesystem in p h p"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Unit-testing the filesystem in PHP","description":"I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like Flysystem or Gaufrette: just a simple mock of the interface and we are done.\nHowever, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling.","inLanguage":"en","wordCount":380,"datePublished":"2019-12-16T11:18:48","dateModified":"2019-12-16T11:18:48","image":"https:\/\/mnavarro.dev\/","keywords":["unit-testing, php, filesystem, stream-wrappers"],"mainEntityOfPage":"https:\/\/mnavarro.dev\/posts\/php-filesystem-unit-testing\/","publisher":{"@type":"Organization","name":"https:\/\/mnavarro.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/mnavarro.dev\/","height":60,"width":60}}}</script><meta property="og:title" content="Unit-testing the filesystem in PHP"><meta property="og:description" content="Efficiently testing PHP's native filesystem functions without hitting a real filesystem"><meta property="og:url" content="https://mnavarro.dev/posts/php-filesystem-unit-testing/"><meta property="og:type" content="website"><meta property="og:site_name" content="mnavarro.dev"><meta name=twitter:title content="Unit-testing the filesystem in PHP"><meta name=twitter:description content="Efficiently testing PHP's native filesystem functions without hitting a real filesystem"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.71.0"><link rel=alternate href=https://mnavarro.dev/index.xml type=application/rss+xml title=mnavarro.dev><link rel=stylesheet href=https://mnavarro.dev/css/style.css><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap" as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap"></noscript><link rel=preload href=https://mnavarro.dev/css/syntax.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://mnavarro.dev/css/syntax.css></noscript><script async defer data-domain=mnavarro.dev src=https://stats.mnavarro.dev/js/index.js></script></head><body><header><div class=wrapper><p class="site-brand muted lambda terminal"><a href=https://mnavarro.dev/>mnavarro.dev</a></p><nav><ul><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/about>About</a></li><li><a title=Media href=/media>Media</a></li><li><a title="Atom Feed" href=/index.xml>Rss</a></li></ul></nav></div></header><main><div class=wrapper><article><h1 class=post-title>Unit-testing the filesystem in PHP</h1><p class=small>16 December 2019
| 2 minutes read
| 380 words</p><div class=content><p>I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like <a href=https://flysystem.thephpleague.com/docs/>Flysystem</a> or <a href=https://github.com/knplabs/Gaufrette>Gaufrette</a>: just a simple mock of the interface and we are done.</p><p>However, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling. I started to get dissapointed of them and started looking at simpler approaches. For instance, PHP supports filesystem abstractions natively in the form of <strong>stream wrappers</strong>. If you don&rsquo;t know about them, you should really <a href=https://dzone.com/articles/the-powerful-resource-of-php-stream-wrappers>take a look at them</a>!</p><p>But there was just one thing that prevented me from going all-in with PHP stream wrappers, and this is that they are really complex to test, because they imply to hit the real filesystem since you cannot mock php filesystem functions.</p><p>Well, it turns out not really. Actually, what if I told you that you can use PHP stream wrappers to create an in-memory filesystem for testing purposes? Actually, you don&rsquo;t even have to create it, because it already exists!</p><p><a href=https://github.com/adlawson/php-vfs><code>adlawson/vfs</code></a> implements such filesystem, which is commonly called a <em>virtual filesystem</em>. They way you use it it&rsquo;s very similar to using a mock. You create the filesystem and leave it in the state you want for your tests. For example, here&rsquo;s a test from one of the Espresso packages where I use it:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=nv>$templateEngineMock</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>createMock</span><span class=p>(</span><span class=nx>TemplateEngineInterface</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
<span class=nv>$transformerMock</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>createMock</span><span class=p>(</span><span class=nx>TransformerInterface</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
<span class=nv>$mimeTypesMock</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>createMock</span><span class=p>(</span><span class=nx>MimeTypes</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>

<span class=c1>// Setting up virtual FS
</span><span class=c1></span><span class=nv>$fs</span> <span class=o>=</span> <span class=nx>FileSystem</span><span class=o>::</span><span class=na>factory</span><span class=p>(</span><span class=s1>&#39;vfs://&#39;</span><span class=p>);</span>
<span class=nv>$fs</span><span class=o>-&gt;</span><span class=na>mount</span><span class=p>();</span>
<span class=c1>// We create a new directory with some files in it
</span><span class=c1></span><span class=nv>$dir</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Directory</span><span class=p>([</span><span class=s1>&#39;bar&#39;</span> <span class=o>=&gt;</span> <span class=k>new</span> <span class=nx>File</span><span class=p>(</span><span class=s1>&#39;Some file with no extension&#39;</span><span class=p>)]);</span>
<span class=c1>// Then we add the directory to the fs
</span><span class=c1></span><span class=nv>$fs</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>add</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=nv>$dir</span><span class=p>);</span>

<span class=nv>$mimeTypesMock</span><span class=o>-&gt;</span><span class=na>expects</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>once</span><span class=p>())</span>
    <span class=o>-&gt;</span><span class=na>method</span><span class=p>(</span><span class=s1>&#39;getMimeType&#39;</span><span class=p>)</span>
    <span class=o>-&gt;</span><span class=na>with</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
    <span class=o>-&gt;</span><span class=na>willReturn</span><span class=p>(</span><span class=k>null</span><span class=p>);</span>

<span class=nv>$simpleResponse</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SimpleResponse</span><span class=p>(</span><span class=nv>$templateEngineMock</span><span class=p>,</span> <span class=nv>$transformerMock</span><span class=p>,</span> <span class=nv>$mimeTypesMock</span><span class=p>);</span>
<span class=nv>$response</span> <span class=o>=</span> <span class=nv>$simpleResponse</span><span class=o>-&gt;</span><span class=na>withDownload</span><span class=p>(</span><span class=s1>&#39;vfs://foo/bar&#39;</span><span class=p>);</span> <span class=c1>// Here we use it
</span></code></pre></div><p>Once we have set up the filesystem, we can use the <code>vfs://</code> stream wrapper like any other stream wrapper. This way, we can test behavior without hitting a real filesystem, what makes our test a truly unit one.</p><p>Make sure you start testing the code depending on PHP native filesystem functions this way. You&rsquo;ll see it&rsquo;s a lot easier to work with, and way more reliable.</p></div><div class=post-terms><p class=small>Taggged
<a href=https://mnavarro.dev/tags/unit-testing/>unit-testing</a>,
<a href=https://mnavarro.dev/tags/php/>php</a>,
<a href=https://mnavarro.dev/tags/filesystem/>filesystem</a>,
<a href=https://mnavarro.dev/tags/stream-wrappers/>stream-wrappers</a>,</p></div><div class=post-nav><div class=post-nav-prev><a href=https://mnavarro.dev/posts/php-efficient-reporting/>Efficient Reports in PHP</a></div><div class=post-nav-next><a href=https://mnavarro.dev/posts/a-brand-new-transbank-sdk/>Un nuevo SDK de Transbank</a></div></div></article><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mnavarro"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main><footer><div class=wrapper><p class=small>Last Modified:
15 October 2020</p><p class="muted lambda">Process exited with code <span id=status>0</span></p></div></footer></body></html>