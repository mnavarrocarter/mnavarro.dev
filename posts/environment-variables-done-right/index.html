<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#282A36"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><title>Environment Variables Done Right - mnavarro.dev</title><meta name=description content="Some advice and guidelines to keep your environment variables under control"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"mnavarro.dev","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/mnavarro.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/mnavarro.dev\/posts\/environment-variables-done-right\/","name":"Environment variables done right"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Environment Variables Done Right","description":"One of the things that I don\x26rsquo;t like about Laravel is their abusive use of environment variables. I think it sets a bad precedent for when developers need to come up with their own environment variables in their applications.\nI have seen environment variables in an application that should have never been environment variables. And other things that should have been but have not made it to the list.\nSo, I thought I\x26rsquo;ll write this piece to rant a bit about this.","inLanguage":"en","wordCount":1037,"datePublished":"2020-07-02T20:00:00","dateModified":"2020-07-02T20:00:00","image":"https:\/\/mnavarro.dev\/","keywords":["env, php, docker, development"],"mainEntityOfPage":"https:\/\/mnavarro.dev\/posts\/environment-variables-done-right\/","publisher":{"@type":"Organization","name":"https:\/\/mnavarro.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/mnavarro.dev\/","height":60,"width":60}}}</script><meta property="og:title" content="Environment Variables Done Right"><meta property="og:description" content="Some advice and guidelines to keep your environment variables under control"><meta property="og:url" content="https://mnavarro.dev/posts/environment-variables-done-right/"><meta property="og:type" content="website"><meta property="og:site_name" content="mnavarro.dev"><meta name=twitter:title content="Environment Variables Done Right"><meta name=twitter:description content="Some advice and guidelines to keep your environment variables under control"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.71.0"><link rel=alternate href=https://mnavarro.dev/index.xml type=application/rss+xml title=mnavarro.dev><link rel=stylesheet href=https://mnavarro.dev/css/style.css><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap" as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap"></noscript><link rel=preload href=https://mnavarro.dev/css/syntax.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://mnavarro.dev/css/syntax.css></noscript><script async defer data-domain=mnavarro.dev src=https://mnavarro.dev/stats.js></script></head><body><header><div class=wrapper><p class="site-brand muted lambda terminal"><a href=https://mnavarro.dev/>mnavarro.dev</a></p><nav><ul><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/about>About</a></li><li><a title=Media href=/media>Media</a></li><li><a title="Atom Feed" href=/index.xml>Rss</a></li></ul></nav></div></header><main><div class=wrapper><article><h1 class=post-title>Environment Variables Done Right</h1><p class=small>2 July 2020
| 5 minutes read
| 1037 words</p><div class=content><p>One of the things that I don&rsquo;t like about Laravel is their abusive use of environment variables. I think it sets a bad precedent for when developers need to come up with their own environment variables in their applications.</p><p>I have seen environment variables in an application that should have never been environment variables. And other things that should have been but have not made it to the list.</p><p>So, I thought I&rsquo;ll write this piece to rant a bit about this.</p><h2 id=know-what-should-be-an-environment-variable>Know what should be an environment variable</h2><p>Environment variables should only be configuration values that change between deployments. Nothing else. For instance, Laravel has it&rsquo;s famous <code>APP_NAME</code> environment variable that is completely useless. If your app name is <code>MonkeyMarket</code> is probably going to be the same in production and staging deploys. No need to make this an environment variable at all. It is not a value related to the environment, but to the application. This is best handled in code.</p><p><code>APP_URL</code> is probably another environment variable that should not exist, since the app url should be derived from the <code>Host</code> http header or any of the <code>X-Forwarded</code> or <code>Forwarded</code> headers (if you are behind a proxy). If you don&rsquo;t do that, then you risk to inconsistencies between the actual app url and the value of the <code>APP_URL</code> variable. Having said that, there are probably some scenarios in which it might make sense, specially if you want to avoid proxy forgery attacks.</p><h2 id=use-uris-to-specify-connection-parameters>Use URIs to specify connection parameters</h2><p>Another thing that Laravel does with their environment variables is to multiply their number without need. For example, in order to specify a database connection, you must set a total of 6 environment variables: <code>DB_CONNECTION</code>, <code>DB_HOST</code>, <code>DB_PORT</code>, <code>DB_DATABASE</code>, <code>DB_USERNAME</code> and <code>DB_PASSWORD</code>. It&rsquo;s a similar thing if you want to configure mailing or storage.</p><p>In order to simplify all these possible options you can make use of URIS. As defined in <a href=https://datatracker.ietf.org/doc/html/rfc3986>RFC 3986</a> they provide a simple and extensible way of defining a resource. In our case, this resource would be a connection to a third party service.</p><p>For instance, instead of all those variables that Laravel defines for a database connection, we could use a single uri string. This even allows us to pass extra configuration in the form of query parameters.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>mysql://user:pass@host:345/db_name?collation=utf8&amp;ssl=true
</code></pre></div><p>What if it gets tricky, like a database connection behind ssh? You still can use a single string and keep complexity of environment variables to a minimum.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>mysql+ssh://user:pass@host:345/db_name?collation=utf8&amp;sshHost=192.168.1.123&amp;sshUser=root#/path/to/ssh/key
</code></pre></div><p>This can work for virtually anything, like mailing, caching, storage, and sessions.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>DATABASE_URI=mysql://user:pass@host:345/db_name
MAILING_URI=smtp://user:pass@host:port?from=app@example.com&amp;ssl=true
CACHING_URI=local:///tmp/cache
STORAGE_URI=s3://accesskey:secret@s3.amazonaws.com/publican?region=us-east-1
SESSION_URI=redis://user:pass@host:port/path/of/keys
</code></pre></div><p>You can easily parse all these values using PHP&rsquo;s <code>parse_url</code> built-in function and get some defaults out of them.</p><h2 id=everything-should-have-a-default>Everything should have a default</h2><p>Is my personal belief that a good application should work out of the box with really dummy defaults. For instance, if your application needs a SQL database, maybe it should work with <code>sqlite</code> by default, either in the filesystem or in memory. If it needs to store session data, it should probably default to the filesystem instead of <code>redis</code>. If it needs to send emails, it should do it in memory or write them in the filesystem unless a real driver is provided.</p><p>No environment variable should be strictly required to run the application, and the defaults should probably be development ones, so every developer in the project can jump quickly boot the environment.</p><h2 id=derive-as-much-non-secret-values-as-you-can>Derive as much non-secret values as you can</h2><p>Something I&rsquo;ve seen a lot in many projects is environment variables with URLS to third party services that the app depends on.</p><p>You might be inclined to store this in an environment variable of the type <code>SERVICE_X_URL</code> too, since the values can change according to the environment. But another lesson to learn here is that in most cases you can derive these values from another environment variable. You could have an <code>APP_ENV</code> variable with some predefined possible values (prod, stage, local, test) and use that to derive other values.</p><p>The better approach in this case is that the urls should be stored in code (constants are useful here) and you should derive the right url according to the current environment stored in the <code>APP_ENV</code> variable.</p><p>So, if <code>APP_ENV</code> equals to the string <code>prod</code>, then you know you should use the production url for that service. In all other cases, you use the staging url. This is very convenient since you don&rsquo;t have to maintain a <code>SERVICE_X_URL</code> environment variable. You could even create mocks of the service and run those when the environment is <code>local</code> or <code>test</code>.</p><p>If the service needs authentication, like a Bearer Token, you should create an environment variable for that, as the token can be different for every deployment, but unlike the url, it is not a secret value, so hardcoding it would be a terrible security best practice violation.</p><p>Also, I should not say that as a good integration practice all that information
should be stored in an class implementation of that service.</p><blockquote><p>NOTE: You should not do this if these are services that could be deployed to different urls (like a pdf converter microservice or some other tool) and therefore could change often. This approach is only useful for services that have a staging url and a production url that usually does not change.</p></blockquote><h2 id=use-other-alternatives>Use other alternatives</h2><p>Some people like to use an <code>APP_DEBUG</code> environment variable to determine if the application should be in debug mode or not. I personally don&rsquo;t like this. Debugging is something you need to turn on and off on demand. Having it in an environment variable means an application restart is required to pick up the changes (in a containerized environment), which could affect your debugging.</p><p>Here the use of feature flags shines. If you use a service discovery tool like Consul, you could store these in their key value store and retrieve them at booting time and use them to configure your services. Redis is another option here.</p><p>So, when you need to debug an issue you could enable that feature and then turn it off when you don&rsquo;t need it anymore.</p><hr><p>Hope these tips help you reason about what environment variables you define in your application and to keep them under control.</p></div><div class=post-terms><p class=small>Taggged
<a href=https://mnavarro.dev/tags/env/>env</a>,
<a href=https://mnavarro.dev/tags/php/>php</a>,
<a href=https://mnavarro.dev/tags/docker/>docker</a>,
<a href=https://mnavarro.dev/tags/development/>development</a>,</p></div><div class=post-nav><div class=post-nav-prev><a href=https://mnavarro.dev/posts/the-case-for-object-mapping/>The case for Object Mapping</a></div><div class=post-nav-next><a href=https://mnavarro.dev/posts/namespaced-taxonomy-sindrome/>Namespaced Taxonomy Syndrome</a></div></div></article><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mnavarro"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main><footer><div class=wrapper><p class=small>Last Modified:
10 June 2021</p><p class="muted lambda">Process exited with code <span id=status>0</span></p></div></footer></body></html>