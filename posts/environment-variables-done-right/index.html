<!doctype html><html lang=en><head><title>Environment Variables Done Right :: The Chilean Nerd</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="One of the things that I don&amp;rsquo;t like about Laravel is their abusive use of environment variables. I think it sets a bad precedent for when developers need to come up with their own environment variables in their applications.
I have seen environment variables in an application that should have never been environment variables. And other things that should have been but have not made it to the list.
So, I thought I&amp;rsquo;ll write this piece to rant a bit about this."><meta name=keywords content="chilean,blog,programming,matias,navarro,carter,php,programming,golang"><meta name=robots content="noodp"><link rel=canonical href=https://mnavarro.dev/posts/environment-variables-done-right/><link rel=stylesheet href=https://mnavarro.dev/assets/style.css><link rel=stylesheet href=https://mnavarro.dev/assets/blue.css><link rel=apple-touch-icon href=https://mnavarro.dev/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://mnavarro.dev/img/favicon/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mnavarrocarter"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Environment Variables Done Right"><meta property="og:description" content="One of the things that I don&amp;rsquo;t like about Laravel is their abusive use of environment variables. I think it sets a bad precedent for when developers need to come up with their own environment variables in their applications.
I have seen environment variables in an application that should have never been environment variables. And other things that should have been but have not made it to the list.
So, I thought I&amp;rsquo;ll write this piece to rant a bit about this."><meta property="og:url" content="https://mnavarro.dev/posts/environment-variables-done-right/"><meta property="og:site_name" content="The Chilean Nerd"><meta property="og:image" content="https://mnavarro.dev/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Tech"><meta property="article:published_time" content="2021-07-02 20:00:00 +0100 +0100"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>The Chilean Nerd</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/showcase>Showcase</a></li><li><a href=https://github.com/mnavarrocarter>Github</a></li><li><a href=/about>About</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>English ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://mnavarro.dev/>English</a></li><li><a href=https://mnavarro.dev/es/>Español</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/showcase>Showcase</a></li><li><a href=https://github.com/mnavarrocarter>Github</a></li><li><a href=/about>About</a></li><hr><li><a href=https://mnavarro.dev/>English</a></li><li><a href=https://mnavarro.dev/es/>Español</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://mnavarro.dev/posts/environment-variables-done-right/>Environment Variables Done Right</a></h1><div class=post-meta><span class=post-date>2021-07-02</span></div><span class=post-tags>#<a href=https://mnavarro.dev/tags/php/>PHP</a>&nbsp;
#<a href=https://mnavarro.dev/tags/docker/>Docker</a>&nbsp;
#<a href=https://mnavarro.dev/tags/development/>Development</a>&nbsp;
#<a href=https://mnavarro.dev/tags/12-factor/>12 Factor</a>&nbsp;</span><div class=post-content><div><p>One of the things that I don&rsquo;t like about Laravel is their abusive use of environment variables. I think it sets a bad precedent for when developers need to come up with their own environment variables in their applications.</p><p>I have seen environment variables in an application that should have never been environment variables. And other things that should have been but have not made it to the list.</p><p>So, I thought I&rsquo;ll write this piece to rant a bit about this.</p><h2 id=know-what-should-be-an-environment-variable>Know what should be an environment variable<a href=#know-what-should-be-an-environment-variable class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Environment variables should only be configuration values that change between deployments. Nothing else. For instance, Laravel has it&rsquo;s famous <code>APP_NAME</code> environment variable that is completely useless. If your app name is <code>MonkeyMarket</code> is probably going to be the same in production and staging deploys. No need to make this an environment variable at all. It is not a value related to the environment, but to the application. This is best handled in code.</p><p><code>APP_URL</code> is probably another environment variable that should not exist, since the app url should be derived from the <code>Host</code> http header or any of the <code>X-Forwarded</code> or <code>Forwarded</code> headers (if you are behind a proxy). If you don&rsquo;t do that, then you risk to inconsistencies between the actual app url and the value of the <code>APP_URL</code> variable. Having said that, there are probably some scenarios in which it might make sense, specially if you want to avoid proxy forgery attacks.</p><h2 id=use-uris-to-specify-connection-parameters>Use URIs to specify connection parameters<a href=#use-uris-to-specify-connection-parameters class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Another thing that Laravel does with their environment variables is to multiply their number without need. For example, in order to specify a database connection, you must set a total of 6 environment variables: <code>DB_CONNECTION</code>, <code>DB_HOST</code>, <code>DB_PORT</code>, <code>DB_DATABASE</code>, <code>DB_USERNAME</code> and <code>DB_PASSWORD</code>. It&rsquo;s a similar thing if you want to configure mailing or storage.</p><p>In order to simplify all these possible options you can make use of URIS. As defined in <a href=https://datatracker.ietf.org/doc/html/rfc3986>RFC 3986</a> they provide a simple and extensible way of defining a resource. In our case, this resource would be a connection to a third party service.</p><p>For instance, instead of all those variables that Laravel defines for a database connection, we could use a single uri string. This even allows us to pass extra configuration in the form of query parameters.</p><pre><code class=language-env data-lang=env>mysql://user:pass@host:345/db_name?collation=utf8&amp;ssl=true
</code></pre><p>What if it gets tricky, like a database connection behind ssh? You still can use a single string and keep complexity of environment variables to a minimum.</p><pre><code class=language-env data-lang=env>mysql+ssh://user:pass@host:345/db_name?collation=utf8&amp;sshHost=192.168.1.123&amp;sshUser=root#/path/to/ssh/key
</code></pre><p>This can work for virtually anything, like mailing, caching, storage, and sessions.</p><pre><code>DATABASE_URI=mysql://user:pass@host:345/db_name
MAILING_URI=smtp://user:pass@host:port?from=app@example.com&amp;ssl=true
CACHING_URI=local:///tmp/cache
STORAGE_URI=s3://accesskey:secret@s3.amazonaws.com/publican?region=us-east-1
SESSION_URI=redis://user:pass@host:port/path/of/keys
</code></pre><p>You can easily parse all these values using PHP&rsquo;s <code>parse_url</code> built-in function and get some defaults out of them.</p><h2 id=everything-should-have-a-default>Everything should have a default<a href=#everything-should-have-a-default class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Is my personal belief that a good application should work out of the box with really dummy defaults. For instance, if your application needs a SQL database, maybe it should work with <code>sqlite</code> by default, either in the filesystem or in memory. If it needs to store session data, it should probably default to the filesystem instead of <code>redis</code>. If it needs to send emails, it should do it in memory or write them in the filesystem unless a real driver is provided.</p><p>No environment variable should be strictly required to run the application, and the defaults should probably be development ones, so every developer in the project can jump quickly boot the environment.</p><h2 id=derive-as-much-non-secret-values-as-you-can>Derive as much non-secret values as you can<a href=#derive-as-much-non-secret-values-as-you-can class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Something I&rsquo;ve seen a lot in many projects is environment variables with URLS to third party services that the app depends on.</p><p>You might be inclined to store this in an environment variable of the type <code>SERVICE_X_URL</code> too, since the values can change according to the environment. But another lesson to learn here is that in most cases you can derive these values from another environment variable. You could have an <code>APP_ENV</code> variable with some predefined possible values (prod, stage, local, test) and use that to derive other values.</p><p>The better approach in this case is that the urls should be stored in code (constants are useful here) and you should derive the right url according to the current environment stored in the <code>APP_ENV</code> variable.</p><p>So, if <code>APP_ENV</code> equals to the string <code>prod</code>, then you know you should use the production url for that service. In all other cases, you use the staging url. This is very convenient since you don&rsquo;t have to maintain a <code>SERVICE_X_URL</code> environment variable. You could even create mocks of the service and run those when the environment is <code>local</code> or <code>test</code>.</p><p>If the service needs authentication, like a Bearer Token, you should create an environment variable for that, as the token can be different for every deployment, but unlike the url, it is not a secret value, so hardcoding it would be a terrible security best practice violation.</p><p>Also, I should not say that as a good integration practice all that information
should be stored in an class implementation of that service.</p><blockquote><p>NOTE: You should not do this if these are services that could be deployed to different urls (like a pdf converter microservice or some other tool) and therefore could change often. This approach is only useful for services that have a staging url and a production url that usually does not change.</p></blockquote><h2 id=use-other-alternatives>Use other alternatives<a href=#use-other-alternatives class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Some people like to use an <code>APP_DEBUG</code> environment variable to determine if the application should be in debug mode or not. I personally don&rsquo;t like this. Debugging is something you need to turn on and off on demand. Having it in an environment variable means an application restart is required to pick up the changes (in a containerized environment), which could affect your debugging.</p><p>Here the use of feature flags shines. If you use a service discovery tool like Consul, you could store these in their key value store and retrieve them at booting time and use them to configure your services. Redis is another option here.</p><p>So, when you need to debug an issue you could enable that feature and then turn it off when you don&rsquo;t need it anymore.</p><hr><p>Hope these tips help you reason about what environment variables you define in your application and to keep them under control.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mnavarro.dev/posts/http-sdk-testing-in-go/><span class=button__icon>←</span>
<span class=button__text>Testing HTTP SDKs in Golang</span></a></span>
<span class="button next"><a href=https://mnavarro.dev/posts/job-hunting-realizations/><span class=button__text>Job Hunting Realizations</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>©2019 Matias Navarro Carter. CC-BY-SA.</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://mnavarro.dev/assets/main.js></script><script src=https://mnavarro.dev/assets/prism.js></script><script src=https://mnavarro.dev/assets/languageSelector.js></script></div></body></html>