<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Filesystem on The Chilean Nerd</title><link>https://mnavarro.dev/tags/filesystem/</link><description>Recent content in Filesystem on The Chilean Nerd</description><generator>Hugo -- gohugo.io</generator><language>en-GB</language><copyright>Â©2019 Matias Navarro Carter. CC-BY-SA.</copyright><lastBuildDate>Mon, 16 Dec 2019 11:18:48 -0300</lastBuildDate><atom:link href="https://mnavarro.dev/tags/filesystem/index.xml" rel="self" type="application/rss+xml"/><item><title>Unit-testing the filesystem in PHP</title><link>https://mnavarro.dev/posts/php-filesystem-unit-testing/</link><pubDate>Mon, 16 Dec 2019 11:18:48 -0300</pubDate><guid>https://mnavarro.dev/posts/php-filesystem-unit-testing/</guid><description>I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like Flysystem or Gaufrette: just a simple mock of the interface and we are done.
However, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling.</description><content>&lt;p>I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like &lt;a href="https://flysystem.thephpleague.com/docs/">Flysystem&lt;/a> or &lt;a href="https://github.com/knplabs/Gaufrette">Gaufrette&lt;/a>: just a simple mock of the interface and we are done.&lt;/p>
&lt;p>However, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling. I started to get dissapointed of them and started looking at simpler approaches. For instance, PHP supports filesystem abstractions natively in the form of &lt;strong>stream wrappers&lt;/strong>. If you don&amp;rsquo;t know about them, you should really &lt;a href="https://dzone.com/articles/the-powerful-resource-of-php-stream-wrappers">take a look at them&lt;/a>!&lt;/p>
&lt;p>But there was just one thing that prevented me from going all-in with PHP stream wrappers, and this is that they are really complex to test, because they imply to hit the real filesystem since you cannot mock php filesystem functions.&lt;/p>
&lt;p>Well, it turns out not really. Actually, what if I told you that you can use PHP stream wrappers to create an in-memory filesystem for testing purposes? Actually, you don&amp;rsquo;t even have to create it, because it already exists!&lt;/p>
&lt;p>&lt;a href="https://github.com/adlawson/php-vfs">&lt;code>adlawson/vfs&lt;/code>&lt;/a> implements such filesystem, which is commonly called a &lt;em>virtual filesystem&lt;/em>. They way you use it it&amp;rsquo;s very similar to using a mock. You create the filesystem and leave it in the state you want for your tests. For example, here&amp;rsquo;s a test from one of the Espresso packages where I use it:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">&amp;lt;?php&lt;/span>
$templateEngineMock &lt;span style="color:#f92672">=&lt;/span> $this&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">createMock&lt;/span>(&lt;span style="color:#a6e22e">TemplateEngineInterface&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>);
$transformerMock &lt;span style="color:#f92672">=&lt;/span> $this&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">createMock&lt;/span>(&lt;span style="color:#a6e22e">TransformerInterface&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>);
$mimeTypesMock &lt;span style="color:#f92672">=&lt;/span> $this&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">createMock&lt;/span>(&lt;span style="color:#a6e22e">MimeTypes&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>);
&lt;span style="color:#75715e">// Setting up virtual FS
&lt;/span>&lt;span style="color:#75715e">&lt;/span>$fs &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">FileSystem&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">factory&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;vfs://&amp;#39;&lt;/span>);
$fs&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">mount&lt;/span>();
&lt;span style="color:#75715e">// We create a new directory with some files in it
&lt;/span>&lt;span style="color:#75715e">&lt;/span>$dir &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Directory&lt;/span>([&lt;span style="color:#e6db74">&amp;#39;bar&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">File&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Some file with no extension&amp;#39;&lt;/span>)]);
&lt;span style="color:#75715e">// Then we add the directory to the fs
&lt;/span>&lt;span style="color:#75715e">&lt;/span>$fs&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;foo&amp;#39;&lt;/span>, $dir);
$mimeTypesMock&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">expects&lt;/span>($this&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">once&lt;/span>())
&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">method&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;getMimeType&amp;#39;&lt;/span>)
&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">with&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>)
&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">willReturn&lt;/span>(&lt;span style="color:#66d9ef">null&lt;/span>);
$simpleResponse &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">SimpleResponse&lt;/span>($templateEngineMock, $transformerMock, $mimeTypesMock);
$response &lt;span style="color:#f92672">=&lt;/span> $simpleResponse&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">withDownload&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;vfs://foo/bar&amp;#39;&lt;/span>); &lt;span style="color:#75715e">// Here we use it
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once we have set up the filesystem, we can use the &lt;code>vfs://&lt;/code> stream wrapper like any other stream wrapper. This way, we can test behavior without hitting a real filesystem, what makes our test a truly unit one.&lt;/p>
&lt;p>Make sure you start testing the code depending on PHP native filesystem functions this way. You&amp;rsquo;ll see it&amp;rsquo;s a lot easier to work with, and way more reliable.&lt;/p></content></item></channel></rss>