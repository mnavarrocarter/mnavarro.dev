<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#282A36"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><title>Repository Pattern Done Right - mnavarro.dev</title><meta name=description content="My long take on how to implement repositories in an abstract, collection-like, immutable way"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"mnavarro.dev","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/mnavarro.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/mnavarro.dev\/posts\/repository-pattern-done-right\/","name":"Repository pattern done right"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Repository Pattern Done Right","description":"The repository pattern is one of the most well established patterns in Domain Driven Design. It\x26rsquo;s origins can be traced as early as when Object Oriented Programing was born.\nOf course, like it happens with almost every pattern or tool, you can really use it terribly the first time (or even the second, or the third one). The only way to improve upon that is good literature and seeing other, more appropriate, uses of the pattern\/tool.","inLanguage":"en","wordCount":2206,"datePublished":"2020-02-17T20:00:00","dateModified":"2020-02-17T20:00:00","image":"https:\/\/mnavarro.dev\/","keywords":["php, oop, repository, orm"],"mainEntityOfPage":"https:\/\/mnavarro.dev\/posts\/repository-pattern-done-right\/","publisher":{"@type":"Organization","name":"https:\/\/mnavarro.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/mnavarro.dev\/","height":60,"width":60}}}</script><meta property="og:title" content="Repository Pattern Done Right"><meta property="og:description" content="My long take on how to implement repositories in an abstract, collection-like, immutable way"><meta property="og:url" content="https://mnavarro.dev/posts/repository-pattern-done-right/"><meta property="og:type" content="website"><meta property="og:site_name" content="mnavarro.dev"><meta name=twitter:title content="Repository Pattern Done Right"><meta name=twitter:description content="My long take on how to implement repositories in an abstract, collection-like, immutable way"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.71.0"><link rel=alternate href=https://mnavarro.dev/index.xml type=application/rss+xml title=mnavarro.dev><link rel=stylesheet href=https://mnavarro.dev/css/style.css><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap" as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap"></noscript><link rel=preload href=https://mnavarro.dev/css/syntax.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://mnavarro.dev/css/syntax.css></noscript><script async defer data-domain=mnavarro.dev src=https://mnavarro.dev/stats.js></script></head><body><header><div class=wrapper><p class="site-brand muted lambda terminal"><a href=https://mnavarro.dev/>mnavarro.dev</a></p><nav><ul><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/about>About</a></li><li><a title=Media href=/media>Media</a></li><li><a title="Atom Feed" href=/index.xml>Rss</a></li></ul></nav></div></header><main><div class=wrapper><article><h1 class=post-title>Repository Pattern Done Right</h1><p class=small>17 February 2020
| 11 minutes read
| 2206 words</p><div class=content><p>The repository pattern is one of the most well established patterns in Domain Driven Design. It&rsquo;s origins can be traced as early as when Object Oriented Programing was born.</p><p>Of course, like it happens with almost every pattern or tool, you can really use it terribly the first time (or even the second, or the third one). The only way to improve upon that is good literature and seeing other, more appropriate, uses of the pattern/tool. Refining your use of tools and patterns this way is, with almost all certainty, the only way to grow as a developer. Years of experience don&rsquo;t count much if you have been doing the same thing, the same way, over and over again.</p><p>This is why I implement and use repositories very differently now than the first time I started. This is probably because of the experience (both good and bad) that I&rsquo;ve accumulated over the years. I&rsquo;ve also read quite a lot on the topic, and certainly I&rsquo;m not the only one that has experienced issues implementing repositories in my applications.</p><p>So, with the years, I&rsquo;ve come to a definition of repositories, and is this one:</p><blockquote><p>Repositories are an specific and immutable abstraction over a collection of domain objects.</p><p>~ Matías Navarro Carter</p></blockquote><p>Let me tell you what I mean by that.</p><h2 id=warning-active-record-users>Warning: Active Record Users</h2><p>Repositories tend to work with ORMs &ndash; even though is not a requirement, it&rsquo;s very common practice. However, not any kind of ORM can be used for working with repositories. I think a word of warning is necessary for users of Active Record ORMs (I&rsquo;m talking about you, Yii and Laravel users). I&rsquo;ve read several blog posts (like <a href=https://dev.to/asperbrothers/laravel-repository-pattern-how-to-use-why-it-matters-1g9d>this one</a>, or <a href=https://itnext.io/repository-design-pattern-done-right-in-laravel-d177b5fa75d4>this other one</a>) that promise an implementation of repositories the Laravel Way™, which is really not the repository pattern, but a poorly abstracted interface over Eloquent. Don&rsquo;t get me wrong: Active Record ORMs are good on what they do, they just don&rsquo;t fit the requirements for the repository pattern. Don&rsquo;t try to use Active Record ORMs for repositories: they just don&rsquo;t fit the use case. Embrace Active Record: you already made the choice of coupling your data model to your persistence layer. If you won&rsquo;t take my word for it, <a href="https://laravelpodcast.com/episodes/9dafa72e?t=34m3s">take Jeffrey Way&rsquo;s</a>.</p><h2 id=repositories-are-abstractions>Repositories are Abstractions</h2><p>Just to continue with the thread, the main reason why Active Record ORMs don&rsquo;t fit the repository pattern is because <strong>repositories are abstractions</strong>, and Active Record Data Models are not. When you create a data model in Laravel, for example, you are not fetching a <em>pure</em> data class, but a whole lot of other stuff related to persistence, like your database connections, mutators and all sorts of stuff. All that lives in your data model, and that renders it unusable for the level of abstraction required for the repository pattern.</p><p>To be fair with the Eloquent guys, this is true of Doctrine repositories also. If you are using doctrine repositories <em>as they are</em>, you are not abstracting anything away. You are coupled to Doctrine, which is in turn coupled to a relational database engine. That leaves you in the same place as using Eloquent (a bit better though, because your data model is a <em>pure</em> data class).</p><p>In the Symfony world, it&rsquo;s common to see something like this:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>SomeController</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>someMethod</span><span class=p>(</span><span class=nx>Request</span> <span class=nv>$request</span><span class=p>)</span><span class=o>:</span> <span class=nx>Response</span>
    <span class=p>{</span>
        <span class=c1>// This repository is the doctrine&#39;s library one
</span><span class=c1></span>        <span class=nv>$repo</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>getRepository</span><span class=p>(</span><span class=nx>User</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
        <span class=nv>$users</span> <span class=o>=</span> <span class=nv>$repo</span><span class=o>-&gt;</span><span class=na>findAll</span><span class=p>();</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>json</span><span class=p>(</span><span class=nv>$users</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>If you do this, stop. You are not using a <strong>proper</strong> abstraction here. It&rsquo;s true: the Doctrine repository is an abstraction over the <code>EntityManager</code>, <code>QueryBuilder</code>, <code>Connection</code> and a bunch of other stuff: but is a doctrine-specific abstraction. You need a <strong>Domain-specific abstraction</strong>. One abstraction that is only yours, your own contract.</p><p>So what we should do then? We just define an interface:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>User</span>
<span class=p>{</span>
    <span class=c1>// This is your data class
</span><span class=c1></span><span class=p>}</span>

<span class=k>interface</span> <span class=nx>UserRepository</span>
<span class=p>{</span>
    <span class=sd>/**
</span><span class=sd>     * @return iterable|User[]
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>all</span><span class=p>()</span><span class=o>:</span> <span class=nx>iterable</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>add</span><span class=p>(</span><span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>remove</span><span class=p>(</span><span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>ofId</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$userId</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>User</span><span class=p>;</span> 
<span class=p>}</span>
</code></pre></div><p>This is a proper abstraction. Your <code>User</code> class is a class that just contains data. Your <code>UserRepository</code> interface is your contract. You can use the Doctrine repository behind it, but it won&rsquo;t matter this time, because you will type hint the interface to all other classes using it. This way you effectively decouple yourself of any persistence library/engine and get an abstraction you can use all around your codebase.</p><h2 id=repositories-are-specific>Repositories are Specific</h2><p>Note how the <code>UserRepository</code> we defined is <strong>model specific</strong>. A lot of people like to save work by creating a generic repository, that becomes no more than a query abstraction over the persistence library used. Just don&rsquo;t do this:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>Repository</span>
<span class=p>{</span>
    <span class=sd>/**
</span><span class=sd>     * @return iterable|object[]
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>all</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$repositoryClass</span><span class=p>)</span><span class=o>:</span> <span class=nx>iterable</span><span class=p>;</span>
<span class=p>}</span>

</code></pre></div><p>Remember one of the principles of DDD: clear language intent. One repository interface for each model conveys more meaning to that specific repository/model than a generic one. For example: only users can be filtered by email, not buildings.</p><p>Besides with one generic repository for everything, you won&rsquo;t be able to type your concrete model classes to the return or argument types. It&rsquo;s the longer route, but is definitely the most convenient and flexible.</p><h2 id=repositories-are-collections>Repositories are Collections</h2><p>I would say that the &ldquo;Aha!&rdquo; moment in repositories for me is when I realized that they are just an abstraction over a collection of objects. This blew my mind and gave me a new challenge; the challenge of implement repositories as if they were an in-memory collection.</p><p>For starters, I dumped all methods like <code>all()</code>, <code>allActiveUsers()</code> or <code>allActiveUsersOfThisMonth()</code>. If you have read the two famous posts about taming repositories, first the one of <a href=http://drafts.easybib.com/post/44139111915/taiming-repository-classes-in-doctrine-with-the>Anne at Easybib</a> and then the one of <a href=https://beberlei.de/2013/03/04/doctrine_repositories.html>Benjamin Eberlei in response</a>, you should know that methods like that in a repository can really grow wild. Also, you don&rsquo;t need all the complexity of the specification pattern: we can do better and simpler than that.</p><p>Collections apis have many distinctive features: the possibility of slice them, filter them, and add or remove new items to them as well as getting individual items. But we don&rsquo;t want a general collection api, remember? We want to implement a specific api for every model, so it conveys meaning.</p><p>So, our <code>UserRepository</code> interface could look this way:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>UserRepository</span> <span class=k>extends</span> <span class=nx>Countable</span><span class=p>,</span> <span class=nx>IteratorAggregate</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>add</span><span class=p>(</span><span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>remove</span><span class=p>(</span><span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>ofId</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$userId</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>User</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>ofEmail</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$email</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>User</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>withActiveStatus</span><span class=p>()</span><span class=o>:</span> <span class=nx>self</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>registeredAfter</span><span class=p>(</span><span class=nx>DateTimeInterface</span> <span class=nv>$date</span><span class=p>)</span><span class=o>:</span> <span class=nx>self</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>registeredBefore</span><span class=p>(</span><span class=nx>DateTimeInterface</span> <span class=nv>$date</span><span class=p>)</span><span class=o>:</span> <span class=nx>self</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>getIterator</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>slice</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$start</span><span class=p>,</span> <span class=nx>int</span> <span class=nv>$size</span> <span class=o>=</span> <span class=mi>20</span><span class=p>)</span><span class=o>:</span> <span class=nx>self</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>count</span><span class=p>()</span><span class=o>:</span> <span class=nx>int</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Pay special attention to the last three methods. These are the only methods that could potentially be in a <code>Repository</code> base interface, because all of them will be sliceable, countable and iterable.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>Repository</span> <span class=k>extends</span> <span class=nx>IteratorAggregate</span><span class=p>,</span> <span class=nx>Countable</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>getIterator</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>slice</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$start</span><span class=p>,</span> <span class=nx>int</span> <span class=nv>$size</span> <span class=o>=</span> <span class=mi>20</span><span class=p>)</span><span class=o>:</span> <span class=nx>self</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>count</span><span class=p>()</span><span class=o>:</span> <span class=nx>int</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>So by doing this, all of your repositories will be sliceable (think pagination there), iterable and countable. The idea is that you apply the filtering methods (all the methods that return <code>self</code>) and then iterate to execute the internal query ¡just like an in-memory collection! In fact, you wouldn&rsquo;t note the difference at all if an implementation is switched to another one.</p><p>This is good OOP. All the persistence details are completely hidden from us, the api is composable and fits our needs for a repository. It looks neat and using it is really simple and easy to understand:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>SomeService</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>UserRepository</span> <span class=nv>$users</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>users</span> <span class=o>=</span> <span class=nv>$users</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>someMethod</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$users</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>users</span>
            <span class=o>-&gt;</span><span class=na>withActiveStatus</span><span class=p>()</span>
            <span class=o>-&gt;</span><span class=na>registeredBefore</span><span class=p>(</span><span class=k>new</span> <span class=nx>DateTime</span><span class=p>(</span><span class=s1>&#39;now&#39;</span><span class=p>))</span>
            <span class=o>-&gt;</span><span class=na>registeredAfter</span><span class=p>(</span><span class=k>new</span> <span class=nx>DateTime</span><span class=p>(</span><span class=s1>&#39;-30days&#39;</span><span class=p>));</span>

        <span class=nv>$count</span> <span class=o>=</span> <span class=nv>$users</span><span class=o>-&gt;</span><span class=na>count</span><span class=p>();</span>

        <span class=k>return</span> <span class=nv>$users</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>But here&rsquo;s the question: how do we go about implementing an api like this? If you are a good observer, you might have realized that the filters return an instance of themselves, modifying the internal state of the repository. So in a next query, we will have the filters of the previous query applied, right?</p><h2 id=repositories-are-immutable>Repositories are Immutable</h2><p>Well, that could be right, if we really are modifying the internal state. But in reality, we are cloning the reference of the repository, so we never touch the original one. This is an implementation detail, but a very important one. If we change, let&rsquo;s say, the state of the repository reference that lives inside our DI Container, then we are done: we cannot use that reference again. So the idea is to make it <strong>immutable</strong>.</p><p>Let me show you the final api, implemented in Doctrine ORM. I&rsquo;m going to write some comments and docblocks in the code explaining some things.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>
<span class=k>declare</span><span class=p>(</span><span class=nx>strict_types</span><span class=o>=</span><span class=mi>1</span><span class=p>);</span>

<span class=k>namespace</span> <span class=nx>RepositoryExample\Common</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Doctrine\ORM\EntityManagerInterface</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\ORM\QueryBuilder</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\ORM\Tools\Pagination\Paginator</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Iterator</span><span class=p>;</span>

<span class=sd>/**
</span><span class=sd> * Class DoctrineORMRepository
</span><span class=sd> * 
</span><span class=sd> * This is a custom abstract Doctrine ORM repository. It is meant to be extended by
</span><span class=sd> * every Doctrine ORM repository existing in your project.
</span><span class=sd> * 
</span><span class=sd> * The main features and differences with the EntityRepository provided by Doctrine is
</span><span class=sd> * that this one implements our repository contract in an immutable way.
</span><span class=sd> * 
</span><span class=sd> */</span>
<span class=k>abstract</span> <span class=k>class</span> <span class=nc>DoctrineORMRepository</span> <span class=k>implements</span> <span class=nx>Repository</span>
<span class=p>{</span>
    <span class=sd>/**
</span><span class=sd>     * This is Doctrine&#39;s Entity Manager. It&#39;s fine to expose it to the child class.
</span><span class=sd>     * 
</span><span class=sd>     * @var EntityManagerInterface
</span><span class=sd>     */</span>
    <span class=k>protected</span> <span class=nv>$manager</span><span class=p>;</span>
    <span class=sd>/**
</span><span class=sd>     * We don&#39;t want to expose the query builder to child classes.
</span><span class=sd>     * This is so we are sure the original reference is not modified.
</span><span class=sd>     * 
</span><span class=sd>     * We control the query builder state by providing clones with the `query`
</span><span class=sd>     * method and by cloning it with the `filter` method.
</span><span class=sd>     *
</span><span class=sd>     * @var QueryBuilder
</span><span class=sd>     */</span>
    <span class=k>private</span> <span class=nv>$queryBuilder</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * DoctrineORMRepository constructor.
</span><span class=sd>     * @param EntityManagerInterface $manager
</span><span class=sd>     * @param string $entityClass
</span><span class=sd>     * @param string $alias
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>EntityManagerInterface</span> <span class=nv>$manager</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$entityClass</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$alias</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>manager</span> <span class=o>=</span> <span class=nv>$manager</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>queryBuilder</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>manager</span><span class=o>-&gt;</span><span class=na>createQueryBuilder</span><span class=p>()</span>
            <span class=o>-&gt;</span><span class=na>select</span><span class=p>(</span><span class=nv>$alias</span><span class=p>)</span>
            <span class=o>-&gt;</span><span class=na>from</span><span class=p>(</span><span class=nv>$entityClass</span><span class=p>,</span> <span class=nv>$alias</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * @inheritDoc
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>getIterator</span><span class=p>()</span><span class=o>:</span> <span class=nx>Iterator</span>
    <span class=p>{</span>
        <span class=k>yield</span> <span class=nx>from</span> <span class=k>new</span> <span class=nx>Paginator</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>queryBuilder</span><span class=o>-&gt;</span><span class=na>getQuery</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * @inheritDoc
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>slice</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$start</span><span class=p>,</span> <span class=nx>int</span> <span class=nv>$size</span> <span class=o>=</span> <span class=mi>20</span><span class=p>)</span><span class=o>:</span> <span class=nx>Repository</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filter</span><span class=p>(</span><span class=k>static</span> <span class=k>function</span> <span class=p>(</span><span class=nx>QueryBuilder</span> <span class=nv>$qb</span><span class=p>)</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$start</span><span class=p>,</span> <span class=nv>$size</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$qb</span><span class=o>-&gt;</span><span class=na>setFirstResult</span><span class=p>(</span><span class=nv>$start</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>setMaxResults</span><span class=p>(</span><span class=nv>$size</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * @inheritDoc
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>count</span><span class=p>()</span><span class=o>:</span> <span class=nx>int</span>
    <span class=p>{</span>
        <span class=nv>$paginator</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Paginator</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>queryBuilder</span><span class=o>-&gt;</span><span class=na>getQuery</span><span class=p>());</span>
        <span class=k>return</span> <span class=nv>$paginator</span><span class=o>-&gt;</span><span class=na>count</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Filters the repository using the query builder
</span><span class=sd>     *
</span><span class=sd>     * It clones it and returns a new instance with the modified
</span><span class=sd>     * query builder, so the original reference is preserved.
</span><span class=sd>     *
</span><span class=sd>     * @param callable $filter
</span><span class=sd>     * @return $this
</span><span class=sd>     */</span>
    <span class=k>protected</span> <span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nx>callable</span> <span class=nv>$filter</span><span class=p>)</span><span class=o>:</span> <span class=nx>self</span>
    <span class=p>{</span>
        <span class=nv>$cloned</span> <span class=o>=</span> <span class=k>clone</span> <span class=nv>$this</span><span class=p>;</span>
        <span class=nv>$filter</span><span class=p>(</span><span class=nv>$cloned</span><span class=o>-&gt;</span><span class=na>queryBuilder</span><span class=p>);</span>
        <span class=k>return</span> <span class=nv>$cloned</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Returns a cloned instance of the query builder
</span><span class=sd>     *
</span><span class=sd>     * Use this to perform single result queries.
</span><span class=sd>     *
</span><span class=sd>     * @return QueryBuilder
</span><span class=sd>     */</span>
    <span class=k>protected</span> <span class=k>function</span> <span class=nf>query</span><span class=p>()</span><span class=o>:</span> <span class=nx>QueryBuilder</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=k>clone</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>queryBuilder</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * We allow cloning only from this scope.
</span><span class=sd>     * Also, we clone the query builder always.
</span><span class=sd>     */</span>
    <span class=k>protected</span> <span class=k>function</span> <span class=fm>__clone</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>queryBuilder</span> <span class=o>=</span> <span class=k>clone</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>queryBuilder</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

</code></pre></div><p>That was the abstract repository. Note how we don&rsquo;t expose the <code>QueryBuilder</code>. This is because it&rsquo;s dangerous: an inexperienced developer could apply filters to it and mutate the original reference, causing a massive bug. Instad, we provide two convenience methods for child classes, <code>filter</code> and <code>query</code>. The first one takes a callable which in turn takes a cloned instance of the <code>QueryBuilder</code> as an argument. The second one just returns a cloned <code>QueryBuilder</code> so the child class can query anything.</p><p>Then, we use that api in our <code>UserRepository</code> and implement the remaining methods.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>
<span class=k>declare</span><span class=p>(</span><span class=nx>strict_types</span><span class=o>=</span><span class=mi>1</span><span class=p>);</span>

<span class=k>namespace</span> <span class=nx>RepositoryExample\User</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>DateTime</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\DBAL\Types\Types</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\ORM\EntityManagerInterface</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\ORM\NonUniqueResultException</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\ORM\NoResultException</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Doctrine\ORM\QueryBuilder</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>DomainException</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>RepositoryExample\Common\DoctrineORMRepository</span><span class=p>;</span>

<span class=sd>/**
</span><span class=sd> * Class DoctrineORMUserRepository
</span><span class=sd> * @package RepositoryExample\User
</span><span class=sd> */</span>
<span class=k>final</span> <span class=k>class</span> <span class=nc>DoctrineORMUserRepository</span> <span class=k>extends</span> <span class=nx>DoctrineORMRepository</span> <span class=k>implements</span> <span class=nx>UserRepository</span>
<span class=p>{</span>
    <span class=k>protected</span> <span class=k>const</span> <span class=no>ENTITY_CLASS</span> <span class=o>=</span> <span class=nx>User</span><span class=o>::</span><span class=na>class</span><span class=p>;</span>
    <span class=k>protected</span> <span class=k>const</span> <span class=no>ALIAS</span> <span class=o>=</span> <span class=s1>&#39;user&#39;</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * DoctrineORMUserRepository constructor.
</span><span class=sd>     * @param EntityManagerInterface $manager
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>EntityManagerInterface</span> <span class=nv>$manager</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>parent</span><span class=o>::</span><span class=na>__construct</span><span class=p>(</span><span class=nv>$manager</span><span class=p>,</span> <span class=nx>self</span><span class=o>::</span><span class=na>ENTITY_CLASS</span><span class=p>,</span> <span class=nx>self</span><span class=o>::</span><span class=na>ALIAS</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>add</span><span class=p>(</span><span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>manager</span><span class=o>-&gt;</span><span class=na>persist</span><span class=p>(</span><span class=nv>$user</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>remove</span><span class=p>(</span><span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>manager</span><span class=o>-&gt;</span><span class=na>remove</span><span class=p>(</span><span class=nv>$user</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>ofId</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$id</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>User</span>
    <span class=p>{</span>
        <span class=nv>$object</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>manager</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span><span class=nx>self</span><span class=o>::</span><span class=na>ENTITY_CLASS</span><span class=p>,</span> <span class=nv>$id</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$object</span> <span class=nx>instanceof</span> <span class=nx>User</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nv>$object</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * @param string $email
</span><span class=sd>     * @return User|null
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>ofEmail</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$email</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>User</span>
    <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=nv>$object</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>()</span>
                <span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=s1>&#39;user.email = :email&#39;</span><span class=p>)</span>
                <span class=o>-&gt;</span><span class=na>setParameter</span><span class=p>(</span><span class=s1>&#39;email&#39;</span><span class=p>,</span> <span class=nv>$email</span><span class=p>)</span>
                <span class=o>-&gt;</span><span class=na>getQuery</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>getSingleResult</span><span class=p>();</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>NoResultException</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>NonUniqueResultException</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=nx>DomainException</span><span class=p>(</span><span class=s1>&#39;More than one result found&#39;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=nv>$object</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>withActiveStatus</span><span class=p>()</span><span class=o>:</span> <span class=nx>UserRepository</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filter</span><span class=p>(</span><span class=k>static</span> <span class=k>function</span> <span class=p>(</span><span class=nx>QueryBuilder</span> <span class=nv>$qb</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$qb</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=s1>&#39;user.active = true&#39;</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>registeredBefore</span><span class=p>(</span><span class=nx>DateTime</span> <span class=nv>$time</span><span class=p>)</span><span class=o>:</span> <span class=nx>UserRepository</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filter</span><span class=p>(</span><span class=k>static</span> <span class=k>function</span> <span class=p>(</span><span class=nx>QueryBuilder</span> <span class=nv>$qb</span><span class=p>)</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$time</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$qb</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=s1>&#39;user.registeredAt &lt; :before&#39;</span><span class=p>)</span>
                <span class=o>-&gt;</span><span class=na>setParameter</span><span class=p>(</span><span class=s1>&#39;:before&#39;</span><span class=p>,</span> <span class=nv>$time</span><span class=p>,</span> <span class=nx>Types</span><span class=o>::</span><span class=na>DATETIME_MUTABLE</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>registeredAfter</span><span class=p>(</span><span class=nx>DateTime</span> <span class=nv>$time</span><span class=p>)</span><span class=o>:</span> <span class=nx>UserRepository</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filter</span><span class=p>(</span><span class=k>static</span> <span class=k>function</span> <span class=p>(</span><span class=nx>QueryBuilder</span> <span class=nv>$qb</span><span class=p>)</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$time</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$qb</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=s1>&#39;user.registeredAt &gt; :after&#39;</span><span class=p>)</span>
                <span class=o>-&gt;</span><span class=na>setParameter</span><span class=p>(</span><span class=s1>&#39;:after&#39;</span><span class=p>,</span> <span class=nv>$time</span><span class=p>,</span> <span class=nx>Types</span><span class=o>::</span><span class=na>DATETIME_MUTABLE</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>The result is really nice to work with. I&rsquo;ve taken this approach is several projects so far and it feels great. The method names convey meaning and work well. Creating different implementations like a Doctrine Mongo ODM, Filesystem or In-Memory it&rsquo;s trivial. Implementors just need to take into account the immutability aspect of it, but that&rsquo;s all really.</p><p>I really hope you like this approach as much as I do and start using it in your projects.</p></div><div class=post-terms><p class=small>Taggged
<a href=https://mnavarro.dev/tags/php/>php</a>,
<a href=https://mnavarro.dev/tags/oop/>oop</a>,
<a href=https://mnavarro.dev/tags/repository/>repository</a>,
<a href=https://mnavarro.dev/tags/orm/>orm</a>,</p></div><div class=post-nav><div class=post-nav-prev><a href=https://mnavarro.dev/posts/a-brand-new-transbank-sdk/>Un nuevo SDK de Transbank</a></div><div class=post-nav-next><a href=https://mnavarro.dev/posts/back-to-the-monolith/>Going back to the Monolith well</a></div></div></article><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mnavarro"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main><footer><div class=wrapper><p class=small>Last Modified:
8 September 2021</p><p class="muted lambda">Process exited with code <span id=status>0</span></p></div></footer></body></html>