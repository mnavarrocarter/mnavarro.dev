<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#282A36"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><title>Preventing tenant pollution in multitenant applications - mnavarro.dev</title><meta name=description content="Or how to make your multi tenant application tenant unaware"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"mnavarro.dev","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/mnavarro.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/mnavarro.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/mnavarro.dev\/posts\/tenant-pollution\/","name":"Preventing tenant pollution in multitenant applications"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Preventing tenant pollution in multitenant applications","description":"Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.\nOne of those mistakes is what I\x26rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something.","inLanguage":"en","wordCount":842,"datePublished":"2021-06-06T00:00:00","dateModified":"2021-06-06T00:00:00","image":"https:\/\/mnavarro.dev\/","keywords":["oop, php, multitenancy"],"mainEntityOfPage":"https:\/\/mnavarro.dev\/posts\/tenant-pollution\/","publisher":{"@type":"Organization","name":"https:\/\/mnavarro.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/mnavarro.dev\/","height":60,"width":60}}}</script><meta property="og:title" content="Preventing tenant pollution in multitenant applications"><meta property="og:description" content="Or how to make your multi tenant application tenant unaware"><meta property="og:url" content="https://mnavarro.dev/posts/tenant-pollution/"><meta property="og:type" content="website"><meta property="og:site_name" content="mnavarro.dev"><meta name=twitter:title content="Preventing tenant pollution in multitenant applications"><meta name=twitter:description content="Or how to make your multi tenant application tenant unaware"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.71.0"><link rel=alternate href=https://mnavarro.dev/index.xml type=application/rss+xml title=mnavarro.dev><link rel=stylesheet href=https://mnavarro.dev/css/style.css><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap" as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Mono&display=swap"></noscript><link rel=preload href=https://mnavarro.dev/css/syntax.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://mnavarro.dev/css/syntax.css></noscript><script async defer data-domain=mnavarro.dev src=https://stats.mnavarro.dev/js/index.js></script></head><body><header><div class=wrapper><p class="site-brand muted lambda terminal"><a href=https://mnavarro.dev/>mnavarro.dev</a></p><nav><ul><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/about>About</a></li><li><a title=Media href=/media>Media</a></li><li><a title="Atom Feed" href=/index.xml>Rss</a></li></ul></nav></div></header><main><div class=wrapper><article><h1 class=post-title>Preventing tenant pollution in multitenant applications</h1><p class=small>6 June 2021
| 4 minutes read
| 842 words</p><div class=content><p>Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.</p><p>One of those mistakes is what I&rsquo;ve come to call <strong>tenant pollution</strong>. This means that many services or routines need the tenant as an argument in order to do something. This causes the tenant or the tenant unique identifier to be passed around many layers of the codebase. Basically, the tenant was <strong>everywhere</strong> in the code.</p><p>For example, this is a small part of our filesystem interface:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>Filesystem</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>put</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$tenantId</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$path</span><span class=p>,</span> <span class=nx>StreamInterface</span> <span class=nv>$contents</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>get</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$tenantId</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$path</span><span class=p>)</span><span class=o>:</span> <span class=nx>StreamInterface</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>The implementation contains a <code>TenantProvider</code> that can use the tenant id to retrieve information about the tenant and use that information to determine the folder name where all the tenant files should be stored.</p><p>All of our services are pretty much similar. Here is another example of the <code>EmailFactory</code>, that creates email messages.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>EmailFactory</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>create</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$tenantId</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$messageName</span><span class=p>,</span> <span class=k>array</span> <span class=nv>$data</span> <span class=o>=</span> <span class=p>[])</span><span class=o>:</span> <span class=nx>Email</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>The approach is pretty much similar to the filesystem one. We pass the tenant so we can fetch their settings. With the settings, we will created custom branded emails for our tenant with their corporate logos and images.</p><p>I have to say that when I was implementing all these services I sort of smelled this. Didn&rsquo;t liked it, but I preferred to the alternative of shared internal service state. And there is nothing I am more against than that. It is terrible OOP.</p><p>Many developers would do this. They will remove the tenant and pass it to a setter in the service.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>ConcreteEmailFactory</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>setTenant</span><span class=p>(</span><span class=nx>Tenant</span> <span class=nv>$tenant</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>tenant</span> <span class=o>=</span> <span class=nv>$tenant</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>create</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$messageName</span><span class=p>,</span> <span class=k>array</span> <span class=nv>$data</span> <span class=o>=</span> <span class=p>[])</span><span class=o>:</span> <span class=nx>Email</span>
    <span class=p>{</span>
        <span class=c1>// Do the action.
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>But, once you set the tenant state you could run into all sorts of undesired side effects. PHP does not make this very obvious, due to the fact that when executed in CGI mode all the state is regenerated across requests. But when you are using React PHP or spinning workers in Road Runner, that&rsquo;s when it bites you. If you move to other languages you cannot and must not do this. PHP should not be the exception.</p><p>But I sort of had a realization when working in the frontend with React and other frameworks. You see, state in frontend is everywhere. Everything is side-effecty and built around state. Frontend developers live with this reality all the time. It teaches them not to <em>fear</em> state, but to tame it and manage it properly. This is the reason why React&rsquo;s <code>useEffect</code> hook exists.</p><p>I asked myself. Okay, shared state stored in a service is bad but, is there a way in which I could control it, or tame it?</p><p>I said, first, let&rsquo;s acknowledge it&rsquo;s existence in an interface:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>TenantState</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>initialize</span><span class=p>(</span><span class=nx>Tenant</span> <span class=nv>$tenant</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Now, how can unset that initialized state so I avoid side effects? Like <code>useState</code> in React works: I will return a <code>callable</code>.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>TenantState</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>initialize</span><span class=p>(</span><span class=nx>Tenant</span> <span class=nv>$tenant</span><span class=p>)</span><span class=o>:</span> <span class=nx>callable</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>This is how it would look in the email factory:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>ConcreteEmailFactory</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>initialize</span><span class=p>(</span><span class=nx>Tenant</span> <span class=nv>$tenant</span><span class=p>)</span><span class=o>:</span> <span class=nx>callable</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>tenant</span> <span class=o>=</span> <span class=nv>$tenant</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>function</span> <span class=p>()</span> <span class=p>{</span>
            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>tenant</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
        <span class=p>};</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>create</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$messageName</span><span class=p>,</span> <span class=k>array</span> <span class=nv>$data</span> <span class=o>=</span> <span class=p>[])</span><span class=o>:</span> <span class=nx>Email</span>
    <span class=p>{</span>
        <span class=c1>// Do the action.
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>The secret is this: when executed, the callable will leave the class in it&rsquo;s original state. Now, you can group a bunch of these services into a composite initializer and have a single place in your code where you will initialize all the tenant state, group the callables to unset the state, and then</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>CompositeTenantState</span> <span class=k>implements</span> <span class=nx>TenantState</span>
<span class=p>{</span>
    <span class=sd>/** @param TenantState[] $states **/</span>
    <span class=k>private</span> <span class=k>array</span> <span class=nv>$states</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>TenantState</span> <span class=o>...</span><span class=nv>$states</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>states</span> <span class=o>=</span> <span class=nv>$states</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>initialize</span><span class=p>(</span><span class=nx>Tenant</span> <span class=nv>$tenant</span><span class=p>)</span><span class=o>:</span> <span class=nx>callable</span>
    <span class=p>{</span>
        <span class=nv>$unsets</span> <span class=o>=</span> <span class=p>[];</span>

        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>states</span> <span class=k>as</span> <span class=nv>$state</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$unsets</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$state</span><span class=o>-&gt;</span><span class=na>initialize</span><span class=p>(</span><span class=nv>$tenant</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=k>function</span> <span class=p>()</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$unsets</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$unsets</span> <span class=k>as</span> <span class=nv>$unset</span><span class=p>)</span> <span class=p>{</span>
                <span class=nv>$unset</span><span class=p>();</span>
            <span class=p>}</span> 
        <span class=p>};</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>You implement <code>TenantState</code> in every service that needs the tenant, and you pass it to this composite implementation.</p><p>This approach is great. If you are using middleware, you can initialize all the tenant state early in the pipeline, and then, when the request has finished, you unset all the state you have set. It is useful also for centralizing initialization of many services at once, so if you need to run the same logic in a console command, you can set up all the services for a tenant and use them freely.</p><p>I wish I could have done this since the beginning. Object graphs would be simpler and methods shorter. Well, I guess you never cease to learn.</p></div><div class=post-terms><p class=small>Taggged
<a href=https://mnavarro.dev/tags/oop/>oop</a>,
<a href=https://mnavarro.dev/tags/php/>php</a>,
<a href=https://mnavarro.dev/tags/multitenancy/>multitenancy</a>,</p></div><div class=post-nav><div class=post-nav-prev><a href=https://mnavarro.dev/posts/advice-junior-project-saboteurs/>Advice for junior project saboteurs</a></div><div class=post-nav-next><a href=https://mnavarro.dev/posts/when-to-use-interfaces/>When to use interfaces</a></div></div></article><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mnavarro"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main><footer><div class=wrapper><p class=small>Last Modified:
7 June 2021</p><p class="muted lambda">Process exited with code <span id=status>0</span></p></div></footer></body></html>