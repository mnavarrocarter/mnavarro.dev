<!doctype html><html lang=en><head><title>Unit-testing the filesystem in PHP :: The Chilean Nerd</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like Flysystem or Gaufrette: just a simple mock of the interface and we are done.
However, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling."><meta name=keywords content="chilean,blog,programming,matias,navarro,carter,php,programming,golang"><meta name=robots content="noodp"><link rel=canonical href=https://mnavarro.dev/posts/php-filesystem-unit-testing/><link rel=stylesheet href=https://mnavarro.dev/assets/style.css><link rel=stylesheet href=https://mnavarro.dev/assets/blue.css><link rel=apple-touch-icon href=https://mnavarro.dev/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://mnavarro.dev/img/favicon/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mnavarrocarter"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Unit-testing the filesystem in PHP"><meta property="og:description" content="I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like Flysystem or Gaufrette: just a simple mock of the interface and we are done.
However, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling."><meta property="og:url" content="https://mnavarro.dev/posts/php-filesystem-unit-testing/"><meta property="og:site_name" content="The Chilean Nerd"><meta property="og:image" content="https://mnavarro.dev/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Tech"><meta property="article:published_time" content="2019-12-16 11:18:48 -0300 -0300"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>The Chilean Nerd</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/showcase>Showcase</a></li><li><a href=https://github.com/mnavarrocarter>Github</a></li><li><a href=/about>About</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>English ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://mnavarro.dev/>English</a></li><li><a href=https://mnavarro.dev/es/>Español</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/showcase>Showcase</a></li><li><a href=https://github.com/mnavarrocarter>Github</a></li><li><a href=/about>About</a></li><hr><li><a href=https://mnavarro.dev/>English</a></li><li><a href=https://mnavarro.dev/es/>Español</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://mnavarro.dev/posts/php-filesystem-unit-testing/>Unit-testing the filesystem in PHP</a></h1><div class=post-meta><span class=post-date>2019-12-16</span></div><span class=post-tags>#<a href=https://mnavarro.dev/tags/testing/>Testing</a>&nbsp;
#<a href=https://mnavarro.dev/tags/php/>PHP</a>&nbsp;
#<a href=https://mnavarro.dev/tags/filesystem/>Filesystem</a>&nbsp;
#<a href=https://mnavarro.dev/tags/advanced-php/>Advanced PHP</a>&nbsp;</span><div class=post-content><div><p>I used to be a big fan of filesystem abstractions, not only for the abstraction benefit, but also for the testing benefit as well. It is trivial to unit test classes depending in filesystem abstractions like <a href=https://flysystem.thephpleague.com/docs/>Flysystem</a> or <a href=https://github.com/knplabs/Gaufrette>Gaufrette</a>: just a simple mock of the interface and we are done.</p><p>However, from time to time I was kinda annoyed with some limitations of the abstractions, specially in regards to stream handling. I started to get dissapointed of them and started looking at simpler approaches. For instance, PHP supports filesystem abstractions natively in the form of <strong>stream wrappers</strong>. If you don&rsquo;t know about them, you should really <a href=https://dzone.com/articles/the-powerful-resource-of-php-stream-wrappers>take a look at them</a>!</p><p>But there was just one thing that prevented me from going all-in with PHP stream wrappers, and this is that they are really complex to test, because they imply to hit the real filesystem since you cannot mock php filesystem functions.</p><p>Well, it turns out not really. Actually, what if I told you that you can use PHP stream wrappers to create an in-memory filesystem for testing purposes? Actually, you don&rsquo;t even have to create it, because it already exists!</p><p><a href=https://github.com/adlawson/php-vfs><code>adlawson/vfs</code></a> implements such filesystem, which is commonly called a <em>virtual filesystem</em>. They way you use it it&rsquo;s very similar to using a mock. You create the filesystem and leave it in the state you want for your tests. For example, here&rsquo;s a test from one of the Espresso packages where I use it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>

$templateEngineMock <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>createMock</span>(<span style=color:#a6e22e>TemplateEngineInterface</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>);
$transformerMock <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>createMock</span>(<span style=color:#a6e22e>TransformerInterface</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>);
$mimeTypesMock <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>createMock</span>(<span style=color:#a6e22e>MimeTypes</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>);

<span style=color:#75715e>// Setting up virtual FS
</span><span style=color:#75715e></span>$fs <span style=color:#f92672>=</span> <span style=color:#a6e22e>FileSystem</span><span style=color:#f92672>::</span><span style=color:#a6e22e>factory</span>(<span style=color:#e6db74>&#39;vfs://&#39;</span>);
$fs<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>mount</span>();
<span style=color:#75715e>// We create a new directory with some files in it
</span><span style=color:#75715e></span>$dir <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Directory</span>([<span style=color:#e6db74>&#39;bar&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>File</span>(<span style=color:#e6db74>&#39;Some file with no extension&#39;</span>)]);
<span style=color:#75715e>// Then we add the directory to the fs
</span><span style=color:#75715e></span>$fs<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#39;foo&#39;</span>, $dir);

$mimeTypesMock<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>expects</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>once</span>())
    <span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>method</span>(<span style=color:#e6db74>&#39;getMimeType&#39;</span>)
    <span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>with</span>(<span style=color:#e6db74>&#39;&#39;</span>)
    <span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>willReturn</span>(<span style=color:#66d9ef>null</span>);

$simpleResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SimpleResponse</span>($templateEngineMock, $transformerMock, $mimeTypesMock);
$response <span style=color:#f92672>=</span> $simpleResponse<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>withDownload</span>(<span style=color:#e6db74>&#39;vfs://foo/bar&#39;</span>); <span style=color:#75715e>// Here we use it
</span></code></pre></div><p>Once we have set up the filesystem, we can use the <code>vfs://</code> stream wrapper like any other stream wrapper. This way, we can test behavior without hitting a real filesystem, what makes our test a truly unit one.</p><p>Make sure you start testing the code depending on PHP native filesystem functions this way. You&rsquo;ll see it&rsquo;s a lot easier to work with, and way more reliable.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mnavarro.dev/posts/repository-pattern-done-right/><span class=button__icon>←</span>
<span class=button__text>Repository Pattern Done Right</span></a></span>
<span class="button next"><a href=https://mnavarro.dev/posts/php-efficient-reporting/><span class=button__text>Efficient Reports in PHP</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>©2019 Matias Navarro Carter. CC-BY-SA.</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://mnavarro.dev/assets/main.js></script><script src=https://mnavarro.dev/assets/prism.js></script><script src=https://mnavarro.dev/assets/languageSelector.js></script></div></body></html>