<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.71.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Matias Navarro-Carter"><meta property="og:url" content="https://mnavarro.dev/posts/tenant-pollution/"><link rel=canonical href=https://mnavarro.dev/posts/tenant-pollution/><link rel=alternate type=application/atom+xml href=https://mnavarro.dev/index.xml><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mnavarro.dev\/"},"articleSection":"posts","name":"Preventing tenant pollution in multitenant applications","headline":"Preventing tenant pollution in multitenant applications","description":"Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.\nOne of those mistakes is what I\x26rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something.","inLanguage":"en-US","author":"Matias Navarro-Carter","creator":"Matias Navarro-Carter","publisher":"Matias Navarro-Carter","accountablePerson":"Matias Navarro-Carter","copyrightHolder":"Matias Navarro-Carter","copyrightYear":"2021","datePublished":"2021-06-06 00:00:00 \x2b0100 \x2b0100","dateModified":"2021-06-06 00:00:00 \x2b0100 \x2b0100","url":"https:\/\/mnavarro.dev\/posts\/tenant-pollution\/","keywords":["PHP","OOP","Multitenancy"]}</script><title>Preventing tenant pollution in multitenant applications</title><meta property="og:title" content="Preventing tenant pollution in multitenant applications"><meta property="og:type" content="article"><meta property="og:description" content="Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.
One of those mistakes is what I&amp;rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something."><meta name=description content="Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.
One of those mistakes is what I&amp;rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something."><meta property="og:locale" content="en-GB"><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:0 1 auto;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=/index.xml rel=alternate type=application/rss+xml><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><meta name=twitter:card content="summary"><meta name=twitter:title content="Preventing tenant pollution in multitenant applications"><meta name=twitter:description content="Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.
One of those mistakes is what I&rsquo;ve come to call tenant pollution. This means that many services or routines need the tenant as an argument in order to do something."></head><body><article class="post English" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>Mati's Rants</a></div><div class=header-subtitle>I sound like I'm angry all the time, but I'm a very nice guy. I Promise.</div></header><div class="row end-md center-xs header-items"><div class=header-item><a href=/about target=_blank>About Me</a></div><div class=header-item><a href=/media target=_blank>Media</a></div><div class=header-item><a href=https://github.com/mnavarrocarter target=_blank>Github</a></div></div><div class="row end-xs"><div class="lang-switch col-xs-3 col-xs-offset-9"><a href=/es/>Spanish</a></div></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Preventing tenant pollution in multitenant applications</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2021-06-06 00:00:00 +0100">06 Jun 2021</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://twitter.com/mnavarrocarter>@Matias Navarro-Carter</a></div></div></div></header><div class="post-content markdown-body"><p>Last year I built a multitenant system for my employer Spatialest. It was my first time doing a multitenant system, so I researched a lot before doing it. I studied carefully the experience of platforms like Shopify, as their multi tenant requirements were similar to ours. But even after some careful study, I made some mistakes.</p><p>One of those mistakes is what I&rsquo;ve come to call <strong>tenant pollution</strong>. This means that many services or routines need the tenant as an argument in order to do something. This causes the tenant or the tenant unique identifier to be passed around many layers of the codebase. Basically, the tenant was <strong>everywhere</strong> in the code.</p><p>For example, this is a small part of our filesystem interface:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Filesystem</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span> <span style=color:#000>$tenantId</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>string</span> <span style=color:#000>$path</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>StreamInterface</span> <span style=color:#000>$contents</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>void</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span> <span style=color:#000>$tenantId</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>string</span> <span style=color:#000>$path</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>StreamInterface</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>The implementation contains a <code>TenantProvider</code> that can use the tenant id to retrieve information about the tenant and use that information to determine the folder name where all the tenant files should be stored.</p><p>All of our services are pretty much similar. Here is another example of the <code>EmailFactory</code>, that creates email messages.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>EmailFactory</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span> <span style=color:#000>$tenantId</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>string</span> <span style=color:#000>$messageName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>array</span> <span style=color:#000>$data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[])</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Email</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>The approach is pretty much similar to the filesystem one. We pass the tenant so we can fetch their settings. With the settings, we will created custom branded emails for our tenant with their corporate logos and images.</p><p>I have to say that when I was implementing all these services I sort of smelled this. Didn&rsquo;t liked it, but I preferred to the alternative of shared internal service state. And there is nothing I am more against than that. It is terrible OOP.</p><p>Many developers would do this. They will remove the tenant and pass it to a setter in the service.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConcreteEmailFactory</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>setTenant</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Tenant</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>void</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>$this</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#c4a000>tenant</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span> <span style=color:#000>$messageName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>array</span> <span style=color:#000>$data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[])</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Email</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Do the action.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>But, once you set the tenant state you could run into all sorts of undesired side effects. PHP does not make this very obvious, due to the fact that when executed in CGI mode all the state is regenerated across requests. But when you are using React PHP or spinning workers in Road Runner, that&rsquo;s when it bites you. If you move to other languages you cannot and must not do this. PHP should not be the exception.</p><p>But I sort of had a realization when working in the frontend with React and other frameworks. You see, state in frontend is everywhere. Everything is side-effecty and built around state. Frontend developers live with this reality all the time. It teaches them not to <em>fear</em> state, but to tame it and manage it properly. This is the reason why React&rsquo;s <code>useEffect</code> hook exists.</p><p>I asked myself. Okay, shared state stored in a service is bad but, is there a way in which I could control it, or tame it?</p><p>I said, first, let&rsquo;s acknowledge it&rsquo;s existence in an interface:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TenantState</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Tenant</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>void</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Now, how can unset that initialized state so I avoid side effects? Like <code>useState</code> in React works: I will return a <code>callable</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TenantState</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Tenant</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>callable</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>This is how it would look in the email factory:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConcreteEmailFactory</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Tenant</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>callable</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>$this</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#c4a000>tenant</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>$this</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#c4a000>tenant</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#000;font-weight:700>};</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span> <span style=color:#000>$messageName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>array</span> <span style=color:#000>$data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[])</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Email</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Do the action.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>The secret is this: when executed, the callable will leave the class in it&rsquo;s original state. Now, you can group a bunch of these services into a composite initializer and have a single place in your code where you will initialize all the tenant state, group the callables to unset the state, and then return them.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#8f5902;font-style:italic>&lt;?php</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CompositeTenantState</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TenantState</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/** @param TenantState[] $states **/</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>array</span> <span style=color:#000>$states</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>__construct</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>TenantState</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>$states</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>$this</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#c4a000>states</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$states</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Tenant</span> <span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>callable</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>$unsets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[];</span>

        <span style=color:#204a87;font-weight:700>foreach</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>$this</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#c4a000>states</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>$state</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>$unsets</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$state</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#c4a000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>$tenant</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#000;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>use</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>$unsets</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>foreach</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>$unsets</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>$unset</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#000>$unset</span><span style=color:#000;font-weight:700>();</span>
            <span style=color:#000;font-weight:700>}</span> 
        <span style=color:#000;font-weight:700>};</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>You implement <code>TenantState</code> in every service that needs the tenant, and you pass it to this composite implementation.</p><p>This approach is great. If you are using middleware, you can initialize all the tenant state early in the pipeline, and then, when the request has finished, you unset all the state you have set. It is useful also for centralizing initialization of many services at once, so if you need to run the same logic in a console command, you can set up all the services for a tenant and use them freely.</p><p>I wish I could have done this since the beginning. Object graphs would be simpler and methods shorter. Well, I guess you never cease to learn.</p></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/php/>PHP</a></div><div class=post-tags><a href=/tags/oop/>OOP</a></div><div class=post-tags><a href=/tags/multitenancy/>Multitenancy</a></div></div></div><div class=row><div class=col-xs-12></div></div><div class=related-content><h3>Related Posts</h3><ul><li><a href=/posts/namespaced-taxonomy-sindrome/>Namespaced Taxonomy Syndrome</a></li><li><a href=/posts/the-case-for-object-mapping/>The case for Object Mapping</a></li><li><a href=/posts/repository-pattern-done-right/>Repository Pattern Done Right</a></li></ul></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var d=document,s=d.createElement("script");s.src="https://mnavarro.disqus.com/embed.js";s.setAttribute("data-timestamp",+new Date());(d.head||d.body).appendChild(s);})();});</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script></script></body></html>