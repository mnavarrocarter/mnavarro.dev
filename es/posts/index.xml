<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on El Chileno Nerd</title><link>https://mnavarro.dev/es/posts/</link><description>Recent content in Posts on El Chileno Nerd</description><generator>Hugo -- gohugo.io</generator><language>en-GB</language><copyright>©2019 Matias Navarro Carter. CC-BY-SA.</copyright><lastBuildDate>Tue, 07 Jan 2020 11:18:48 -0300</lastBuildDate><atom:link href="https://mnavarro.dev/es/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Un Nuevo SDK de Transbank</title><link>https://mnavarro.dev/es/posts/sdk-de-transbank/</link><pubDate>Tue, 07 Jan 2020 11:18:48 -0300</pubDate><guid>https://mnavarro.dev/es/posts/sdk-de-transbank/</guid><description>&lt;p>Si has usado el SDK de Transbank para PHP quizás entiendas la frustación que me motivó a escribir un nuevo SDK no oficial. Hace mucho tiempo que tenía este proyecto en mente y decidí que el mundo no podía comenzar otra década sin un nuevo SDK de Transbank.&lt;/p></description><content>&lt;p>Si has usado el SDK de Transbank para PHP quizás entiendas la frustación que me motivó a escribir un nuevo SDK no oficial. Hace mucho tiempo que tenía este proyecto en mente y decidí que el mundo no podía comenzar otra década sin un nuevo SDK de Transbank.&lt;/p>
&lt;p>Así que, sin más, les presento a&amp;hellip;&lt;/p>
&lt;p>&lt;a href="https://github.com/better-transbank/sdk">¡BETTER TRANSBANK SDK!&lt;/a>&lt;/p>
&lt;figure class="left" >
&lt;img src="https://media.giphy.com/media/MOWPkhRAUbR7i/giphy-downsized.gif" />
&lt;/figure>
&lt;p>Este proyecto tiene como objetivo proveer un SDK estable, fácil de usar y seguro, con las mejores prácticas de desarrollo y POO y con un sistema de integración continua sólido y que asegure la calidad del software a cada momento.&lt;/p>
&lt;p>Quisiera contarles las motivaciones, desarrollo y filosofía del proyecto, además de lanzar unas pequeñas ideas que tengo para este proyecto en el futuro.&lt;/p>
&lt;h2 id="hacia-un-mejor-cliente">Hacia un mejor cliente&lt;/h2>
&lt;p>He tenido la suerte de haber desarrollado variadas integraciones de todo tipo. He construido clientes para muchos servicios de terceros y apis públicas, tanto RPC, REST y SOAP (siempre con PHP). Con el tiempo, esta experiencia me ha llevado a madurar ideas sobre lo que constituye un buen cliente.&lt;/p>
&lt;p>Estas son las ideas que he llegado a abrazar como reglas a la hora de construir un cliente &lt;strong>ADECUADO&lt;/strong>.&lt;/p>
&lt;ol>
&lt;li>Un buen cliente debe ser &lt;strong>A&lt;/strong>bstracto&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>D&lt;/strong>ecorable&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>E&lt;/strong>xtensible&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>C&lt;/strong>acheable&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>U&lt;/strong>niforme&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>A&lt;/strong>tractivo&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>D&lt;/strong>ebuggeable&lt;/li>
&lt;li>Un buen cliente debe ser &lt;strong>O&lt;/strong>bvio&lt;/li>
&lt;/ol>
&lt;p>Muchas de estas reglas simplemente no se cumplen en el SDK original. Primero, carece de abstracciones apropiadas (casi no hay encapsulamiento) y el hecho que estamos usando SOAP se desparrama por toda la librería (cuando en realidad el protocolo es un mero detalle de implementación). No es decorable, debido a que no usa interfaces. No es extensible a un nivel de comunicación vía eventos. Carece de uniformidad debido a que no se atreve a reparar las inconsistencias del web service al que abstrae. No es para nada atrativo de usar y el código no usa los estándares de estilo de PHP FIG. Es debuggeable, pero solo al nivel del cliente de SOAP. Y no es muy obvio de usar, debido a que no nombra sus clases y variables de una forma clara.&lt;/p>
&lt;p>Si eres un buen lector te habrás dado cuenta que en ningún lugar mencioné funcionamiento. Esto, porque que algo funcione es lo mínimo que se espera de una pieza de software. El SDK oficial funciona, ¡y bastante bien! Pero cuando hablamos de software no basta con que funcione: el usuario es el foco principal. El usuario debe disfrutar la herramienta que le estamos entregando. No sirve mucho lograr que algo funcione si el hacerlo funcionar se torna en una lucha. Y bueno, tú, querido amigo desarrollador, eres el usuario de este SDK. Espero que disfrutes el usarlo tanto como yo disfruté el desarrollarlo.&lt;/p>
&lt;p>Por todas estas razones, decidí tomar el papel y comenzar desde cero. Esto, porque a pesar de que ha habido intentos de mejorar el SDK (véase &lt;a href="https://github.com/freshworkstudio/transbank-web-services">&lt;code>freshwork/transbank&lt;/code>&lt;/a>), siempre quedan constreñidos por la implementación interna del cliente SOAP y terminan casi replicando el original, sin aportar más que un par de nuevas funcionalidades.&lt;/p>
&lt;p>Asi que, me puse manos a la obra.&lt;/p>
&lt;h2 id="la-api-inicial">La Api Inicial&lt;/h2>
&lt;p>Decidí partir implementando Webpay para lograr un MVP. Haciendo a un lado todos los detalles de implementación, como SOAP, construcción de XML, firmado de XML y otras cosas, el webservice de transbank nos expone tres métodos para nuestro uso, que modelé en una interfaz.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">&amp;lt;?php&lt;/span>
&lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">WebpayClient&lt;/span>
{
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">startTransaction&lt;/span>(&lt;span style="color:#a6e22e">Transaction&lt;/span> $transaction)&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">StartTransactionResponse&lt;/span>;
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">getTransactionResult&lt;/span>(&lt;span style="color:#a6e22e">string&lt;/span> $transactionToken)&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">TransactionResult&lt;/span>;
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">confirmTransaction&lt;/span>(&lt;span style="color:#a6e22e">string&lt;/span> $transactionToken)&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">void&lt;/span>;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>A diferencia de este ejemplo, en la librería las interfaces están documentadas, con el propósito de ayudar lo máximo al desarrollador si es que éste cuenta con buenas herramientas de autocompletar.&lt;/p>
&lt;p>Algo importante que debemos notar es que allí donde hay más de dos parámetros en un método, agrupamos esos parámetros en clases tipo DTO (ojalá inmutables) y les damos significado por medio de nombrarlas. Las respuestas complejas también son clases, con una api clara y definida.&lt;/p>
&lt;p>La clase &lt;code>Transaction&lt;/code> es la principal aquí. Intenté modelarla tal y como el wsdl de transbank muestra, manteniendo los parámetros requeridos, opcionales y las estructuras. Parte de la api permite agregar detalles de pago, cambiar el tipo de transacción y provee un static factory para escritura de código fluída.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">&amp;lt;?php&lt;/span>
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">BetterTransbank\SDK\Webpay\Message\Transaction&lt;/span>;
&lt;span style="color:#75715e">// Creamos la transacción con las url
&lt;/span>&lt;span style="color:#75715e">&lt;/span>$transaction &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Transaction&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">create&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;http://redirect.url&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;http://final.url&amp;#39;&lt;/span>)
&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">makeTypeMall&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;OrdenPrincipal&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;2152152111&amp;#39;&lt;/span>) &lt;span style="color:#75715e">// Covertimos la transacción en tipo Mall
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">withAddedDetails&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Orden1234&amp;#39;&lt;/span>, &lt;span style="color:#ae81ff">10000&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;3532362362&amp;#39;&lt;/span>) &lt;span style="color:#75715e">// Añadimos detalles
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">withAddedDetails&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Orden1441&amp;#39;&lt;/span>, &lt;span style="color:#ae81ff">15000&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;5352523&amp;#39;&lt;/span>); &lt;span style="color:#75715e">// Añadimos más detalles
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Transaction&lt;/code> es un mensaje, y es buena práctica que las clases que modelan mensajes en POO sean implementadas de forma inmutable (es decir, que los cambios de estado no modifican la referencia original).&lt;/p>
&lt;h3 id="firmando-los-xml">Firmando los XML&lt;/h3>
&lt;p>Pasar las clases a un arreglo que luego es convertido a XML es trivial para el cliente de SOAP de PHP. Lo que no es para nada trivial es firmar el XML usando el estándar WSSE (que es lo que usa, con un poco de variaciones, los servicios de Transbank).&lt;/p>
&lt;p>Tenía dos opciones: usar unas clases arcanas, complejas y viejas desarrolladas por un tal Robert Richards (que es lo que usa el SDK original) o implementar mi propio mecanismo de firma desde cero.&lt;/p>
&lt;p>Encontré lo segundo más beneficioso y desafiante, debido a que podría aprender cómo funciona el estándar (créanme, ahora soy un experto en firmar XML con WSSE). Asi que pasé unos buenos tres días solo haciendo pruebas de concepto, leyendo los estándares y la documentación y buscando implementaciones en PHP y otros lenguajes.&lt;/p>
&lt;p>Estuve un día entero parado porque Transbank me decía que la firma de mi XML no era válida, hasta que logré dar con el problema: yo estaba firmado el nodo &lt;code>Body&lt;/code> del XML, pero lo que se firma es el nodo canonizado llamado &lt;code>SignedInfo&lt;/code>, que a su vez contiene un &lt;code>Digest&lt;/code> sha1 del nodo canonizado del &lt;code>Body&lt;/code>.&lt;/p>
&lt;p>El proceso, paso por paso por si te interesa, es el siguiente:&lt;/p>
&lt;ol>
&lt;li>Marcar el nodo &lt;code>SOAP-ENV:Body&lt;/code> con un atributo &lt;code>wsu:Id&lt;/code>. Yo use un uuid, tal como el SDK original.&lt;/li>
&lt;li>Añadir el nodo &lt;code>SOAP-ENV:Header&lt;/code> antes que el nodo del body.&lt;/li>
&lt;li>Añadir el &lt;code>wsse:Security&lt;/code> dentro del header, y el &lt;code>ds:Signature&lt;/code> dentro de éste&lt;/li>
&lt;li>Dentro de &lt;code>ds:Signature&lt;/code>, se añaden varios nodos dentro de un &lt;code>ds:SignedInfo&lt;/code> que contiene &lt;code>ds:Reference&lt;/code>. El reference referencia este uuid antes creado, y además calcula un &lt;code>sha1&lt;/code> de la canonicalización del nodo que contiene el &lt;code>wsu:Id&lt;/code>. El sha1 debe estar encodeado en base64 y no en hexadecimal como suele estar.&lt;/li>
&lt;li>Luego, se toma todo este nodo &lt;code>ds:SignedInfo&lt;/code> recién creado, se canoniza y se firma con la llave privada usando &lt;code>openssl_sign&lt;/code>. El algoritmo es sha1 también. La firma se encodea en base64 y se coloca en el nodo &lt;code>ds:SignatureValue&lt;/code>, dentro de &lt;code>ds:Signature&lt;/code>&lt;/li>
&lt;li>Luego, se crea un nodo &lt;code>ds:KeyInfo&lt;/code> dentro de &lt;code>ds:Signature&lt;/code> que contiene la información del certificado público, para que Transbank pueda encontrarlo en su base de datos y validar si el mensaje realmente proviene de nosotros.&lt;/li>
&lt;/ol>
&lt;p>Un xml ya firmado, luce de esta forma:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-xml" data-lang="xml">&lt;span style="color:#f92672">&amp;lt;SOAP-ENV:Envelope&lt;/span> &lt;span style="color:#a6e22e">xmlns:SOAP-ENV=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://schemas.xmlsoap.org/soap/envelope/&amp;#34;&lt;/span>
&lt;span style="color:#a6e22e">xmlns:ns1=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://service.wswebpay.webpay.transbank.com/&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;SOAP-ENV:Header&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;wsse:Security&lt;/span> &lt;span style="color:#a6e22e">xmlns:wsse=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&amp;#34;&lt;/span>
&lt;span style="color:#a6e22e">SOAP-ENV:mustUnderstand=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:Signature&lt;/span> &lt;span style="color:#a6e22e">xmlns:ds=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://www.w3.org/2000/09/xmldsig#&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:SignedInfo&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:CanonicalizationMethod&lt;/span> &lt;span style="color:#a6e22e">Algorithm=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://www.w3.org/2001/10/xml-exc-c14n#&amp;#34;&lt;/span>&lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:SignatureMethod&lt;/span> &lt;span style="color:#a6e22e">Algorithm=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://www.w3.org/2000/09/xmldsig#rsa-sha1&amp;#34;&lt;/span>&lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:Reference&lt;/span> &lt;span style="color:#a6e22e">URI=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;#pfxbaea1ea6-963f-4b71-aaae-e64d8605def3&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:Transforms&amp;gt;&lt;/span>s
&lt;span style="color:#f92672">&amp;lt;ds:Transform&lt;/span> &lt;span style="color:#a6e22e">Algorithm=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://www.w3.org/2001/10/xml-exc-c14n#&amp;#34;&lt;/span>&lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:Transforms&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:DigestMethod&lt;/span> &lt;span style="color:#a6e22e">Algorithm=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://www.w3.org/2000/09/xmldsig#sha1&amp;#34;&lt;/span>&lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:DigestValue&amp;gt;&lt;/span>N034GgBG1Q9Gx/OH1iq9ala4M8k=&lt;span style="color:#f92672">&amp;lt;/ds:DigestValue&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:Reference&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:SignedInfo&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:SignatureValue&amp;gt;&lt;/span>
DVXWn1IpviwmaujYb3q97SOV3l/5BDrA9sTFjg51x5tSjrUlmelIHC5sx7Sjw/R8qHb2i0BL642uW2i7cZMUgmEUGemQQNI3e4W1QVXJT6iQlSgi3/kGO8OTSaiAraG7EFHeKLyf2m2HY/Nv2n9zzYIM2MPKtytQ7rumpp3tXLc9bvo5XZSCobCsNJzj01DxXiZy3+uxCB2G7a8PPvUNbl99Fa7XoRk2PjLKcpx/WBNQLlHZ6e5pho1EFRfGS0svrPUoE9mxKg/FdDuLc8/p22GOFvXBDAviUlxR9IwqoIgM2BCXTC3PAgmRFaDck9EfUpcwqnIubLjNJj1SEtCFeA==
&lt;span style="color:#f92672">&amp;lt;/ds:SignatureValue&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:KeyInfo&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;wsse:SecurityTokenReference&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:X509Data&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:X509IssuerSerial&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:X509IssuerName&amp;gt;&lt;/span>
C=cl,ST=stgo,L=stgo,O=tbk,OU=ccrr,CN=597020000540,emailAddress=ccrr@gmail.com
&lt;span style="color:#f92672">&amp;lt;/ds:X509IssuerName&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ds:X509SerialNumber&amp;gt;&lt;/span>16407850704409370121&lt;span style="color:#f92672">&amp;lt;/ds:X509SerialNumber&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:X509IssuerSerial&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:X509Data&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/wsse:SecurityTokenReference&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:KeyInfo&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ds:Signature&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/wsse:Security&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/SOAP-ENV:Header&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;SOAP-ENV:Body&lt;/span> &lt;span style="color:#a6e22e">xmlns:wsu=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&amp;#34;&lt;/span>
&lt;span style="color:#a6e22e">wsu:Id=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;pfxbaea1ea6-963f-4b71-aaae-e64d8605def3&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;ns1:initTransaction&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;wsInitTransactionInput&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;wSTransactionType&amp;gt;&lt;/span>TR_NORMAL_WS&lt;span style="color:#f92672">&amp;lt;/wSTransactionType&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;returnURL&amp;gt;&lt;/span>http://localhost:8000/return&lt;span style="color:#f92672">&amp;lt;/returnURL&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;finalURL&amp;gt;&lt;/span>http://localhost:8000/final&lt;span style="color:#f92672">&amp;lt;/finalURL&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;transactionDetails&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;sharesAmount&amp;gt;&lt;/span>0&lt;span style="color:#f92672">&amp;lt;/sharesAmount&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;sharesNumber&amp;gt;&lt;/span>0&lt;span style="color:#f92672">&amp;lt;/sharesNumber&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;amount&amp;gt;&lt;/span>10000&lt;span style="color:#f92672">&amp;lt;/amount&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;commerceCode&amp;gt;&lt;/span>597020000540&lt;span style="color:#f92672">&amp;lt;/commerceCode&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;buyOrder&amp;gt;&lt;/span>12345&lt;span style="color:#f92672">&amp;lt;/buyOrder&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/transactionDetails&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/wsInitTransactionInput&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/ns1:initTransaction&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/SOAP-ENV:Body&amp;gt;&lt;/span>
&lt;span style="color:#f92672">&amp;lt;/SOAP-ENV:Envelope&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Fue bastante gratificante intelectualmente aprender a realizar el proceso. Incluso aprendí que Transbank no implementa el estándar al 100%, debido a que la información del certificado público suele enviarse en un header &lt;code>wsse:BinarySecurityToken&lt;/code> y no en un &lt;code>ds:KeyInfo&lt;/code>. Si Transbank implementa el estándar en sus herramientas de desarrollo, debería funcionar de esa forma también. Lo probaré en algún momento.&lt;/p>
&lt;figure class="left" >
&lt;img src="https://media.giphy.com/media/26tPnAAJxXTvpLwJy/giphy-downsized.gif" />
&lt;/figure>
&lt;h2 id="utilidades-y-extensibilidad">Utilidades y extensibilidad&lt;/h2>
&lt;p>Luego de que el desarollo duro estuvo terminado, lo único que faltaba era desarrollar un par de utilidades más y hacerlo un poco más extensible.&lt;/p>
&lt;p>Por ejemplo, para hacer las redirecciones especiales que requiere Webpay (formularios HTTP enviados programáticamente por medio de javascript), he desarrollado un par de clases utilitarias que permiten realizar este proceso de forma extremandamente sencilla. Debo, sin emabargo, dar crédito al SDK de Freshworks Studio por ser los primeros en implementar esta idea.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">&amp;lt;?php&lt;/span>
$response &lt;span style="color:#f92672">=&lt;/span> $webpay&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">startTransaction&lt;/span>($transaction);
&lt;span style="color:#a6e22e">PaymentForm&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">prepare&lt;/span>($response)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">send&lt;/span>(); &lt;span style="color:#75715e">// Renderiza el formulario de pago y envía headers HTTP como respuesta
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Además, puedes conectarte a cualquier parte del proceso de pago usando una implementación de &lt;a href="https://www.php-fig.org/psr/psr-14/">&lt;code>psr/event-dispatcher&lt;/code>&lt;/a> y el decorador especial del cliente de Webpay.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">&amp;lt;?php&lt;/span>
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">BetterTransbank\SDK\Webpay\SoapWebpayClient&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">BetterTransbank\SDK\Webpay\Psr14\Psr14WebpayClient&lt;/span>;
$webpay &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">WebpaySoapClient&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">fromCredentials&lt;/span>($creds);
$webpay &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Psr14WebpayClient&lt;/span>($webpay, $dispatcher);
$webpay&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">startTransaction&lt;/span>($transaction); &lt;span style="color:#75715e">// Ahora este cliente dispara eventos
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Por último, si necesitas ver información para debuggear requests, puedes usar el cliente SOAP especial
con capacidades de logger. Necesitarás una implementación que use la interfaz recomendada por FIG &lt;code>LoggerInterface&lt;/code>, definida en &lt;a href="https://github.com/php-fig/log">&lt;code>psr/log&lt;/code>&lt;/a>. Casi todos los loggers para PHP usan esa interfaz hoy en día.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">&amp;lt;?php&lt;/span>
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">BetterTransbank\SDK\Soap\LoggerTransbankSoapClient&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">BetterTransbank\SDK\Webpay\SoapWebpayClient&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">BetterTransbank\SDK\Webpay\WebpayCredentials&lt;/span>;
$creds &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">WebpayCredentials&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">normalStaging&lt;/span>();
$logger &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">SomeCOmpatibleLogger&lt;/span>();
$client &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">LoggerTransbankSoapClient&lt;/span>($creds, $logger);
$webpay &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">SoapWebpayClient&lt;/span>($client); &lt;span style="color:#75715e">// Nota como NO creamos automáticamente desde credenciales ahora
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Todas estas son utilidades que permiten una mejor experiencia de desarrollo y una más fácil integración y modificación de la lógica del SDK.&lt;/p>
&lt;h2 id="lo-que-se-viene">Lo que se viene&lt;/h2>
&lt;p>Esta librería &lt;strong>no se encuentra lista para su uso en producción&lt;/strong>. Es por eso que está sólo en versión &lt;code>0.1.0&lt;/code> (al tiempo de la escritura de este artículo). Sin embargo, puedes probarla en desarrollo sin problemas. Sólo tengo implementado Webpay Normal y Mall.&lt;/p>
&lt;p>De todas maneras, tengo un &lt;em>roadmap&lt;/em> bastante claro para llegar a &lt;code>1.0.0&lt;/code>, que será la versión &lt;em>production-ready&lt;/em> de esta librería y que no debería pasar de fines de este mes. Principalmente, son tres grandes cosas las que faltan.&lt;/p>
&lt;p>La primera y una de las cossas más importantes que se necesita es validar la firma de las respuestas de Transbank. Considero esto un riesgo de seguridad demasiado alto como para usar la librería en producción. Una vez esa lógica esté implementada, lo que sigue es corregir los errores de análisis estático encontrados por psalm. Luego de eso, es vital incrementar el coverage de pruebas unitarias/funcionales a un 90%. Una vez que todo esto esté listo, recién entonces &lt;em>taggearé&lt;/em> &lt;code>1.0.0&lt;/code> (podría haber BC breaks en medio, ya que es un release &lt;em>major&lt;/em>).&lt;/p>
&lt;p>Cuando &lt;code>1.0.0&lt;/code> vea la luz, me enfocaré en &lt;code>1.1&lt;/code> que agregará OnePay. Quizá &lt;code>1.2&lt;/code> agregue Webpay Nullify, pero de ahí en adelante el roadmap no lo tengo tan claro.&lt;/p>
&lt;p>Cuando &lt;code>1.0.0&lt;/code> esté completo, en paralelo al resto desarrollaré diferentes integraciones con distintos frameworks y plataformas. Symfony y Laravel serán los primeros, y luego de eso vendrá algún plugin de Wordpress, Magento y/o Prestashop.&lt;/p>
&lt;p>El gran proyecto que tengo en mente para culminar todo esto es el desarrollo de un microservicio que permita implementar Webpay Plus Normal en tiempo récord, con notificaciones de pago al frontend via SSE (La api browser de EventSource).&lt;/p>
&lt;h2 id="sé-parte">Sé parte&lt;/h2>
&lt;p>Como ves, tengo mucho trabajo que hacer y si quieres ayudarme estaría más que agradecido. Busco personas que prueben el SDK en su versión actual, que ayuden a desarrollar lo que falta, que mejoren la documentación o que me motiven comprándome un cafecito o una cervecita. ¡Todo sirve!&lt;/p>
&lt;p>Si quieres ser el primero en enterarte de todo lo que se viene, no dudes en &lt;a href="https://github.com/better-transbank/sdk">poner una estrella en el repositorio&lt;/a>.&lt;/p>
&lt;p>¡Gracias por leer todo hasta acá! ¡Déjame un comentario para saber si te gustó!&lt;/p></content></item><item><title>Entendiendo Versionamiento Semántico</title><link>https://mnavarro.dev/es/posts/versionamiento-semantico/</link><pubDate>Sat, 12 Oct 2019 11:18:48 -0300</pubDate><guid>https://mnavarro.dev/es/posts/versionamiento-semantico/</guid><description>Hace poco estaba hablando con un colega y recomendándole una librería para ayudarle en un problema que estaba tratando de resolver. Mientras le hablaba de cómo funcionaba la librería, abrió el repositorio Github de la misma y vio el número de version (1.1.5) y me dijo “No es muy buena, está solo en versión 1”.
Lo miré con cara de confundido e inmediatamente me di cuenta que su entendimiento de versionamiento semántico era algo así como “Las buenas librerías son las que tienen un número de version alto”.</description><content>&lt;p>Hace poco estaba hablando con un colega y recomendándole una librería para ayudarle en un problema que estaba tratando de resolver. Mientras le hablaba de cómo funcionaba la librería, abrió el repositorio Github de la misma y vio el número de version (1.1.5) y me dijo “No es muy buena, está solo en versión 1”.&lt;/p>
&lt;p>Lo miré con cara de confundido e inmediatamente me di cuenta que su entendimiento de versionamiento semántico era algo así como “Las buenas librerías son las que tienen un número de version alto”. La realidad es que ese no es el caso.&lt;/p>
&lt;p>Versionamiento Semántico (SemVer por su traducción al inglés) es un estándar muy específico utilizado principalmente en el mundo de proyectos Open Source para versionado de un codebase. Puedes leer la explicación detallada del estándar &lt;a href="https://semver.org/lang/es/">aquí&lt;/a>, pero lo resumiré en este post.&lt;/p>
&lt;p>Sin embargo, antes debemos comprender un par de cosas para poder entender qué problemas trata de resolver el Versionamiento Semántico y cómo es que lo hace.&lt;/p>
&lt;h2 id="compartiendo-librerías">Compartiendo librerías&lt;/h2>
&lt;p>Todos nosotros, cuando programamos, usamos librerías de terceros. A veces necesitamos esa librería para trabajar con archivos excel como stream de datos, o esa otra librería para hacer peticiones HTTP, o quizás otra para trabajar con fechas de mejor manera.&lt;/p>
&lt;p>En los días de antaño, para incluir código de terceros en tu proyecto, tenías que descargar la librería y colocarla en tu código, lo cual era extremadamente ineficiente. Hoy en día, necesitamos movernos más rápido, y la venida de la agilidad en el desarrollo de software hizo necesaria la implementación de formas más eficientes de compartir/integrar código. He aquí el nacimiento de los gestores de dependencias, o gestores de paquetes.&lt;/p>
&lt;p>Lo más probable es que tu lenguaje de programación tiene un gestor de dependencias que te ayuda a instalar estas librerías en tu proyecto de manera fácil. PHP tiene Composer, Node tiene Yarn o NPM, Java y Kotlin tienen Maven y Gradle, Rust tiene Cargo, Ruby tiene Gems, Go tiene Dep, Python tiene Pip, etcétera. Con estas herramientas, simplemente tenemos que especificar el nombre de la librería que queremos ¡y listo!&lt;/p>
&lt;p>¡Genial! Hemos resuelto un problema. ¡Ahora podemos compartir código fácilmente! Pero, este problema creó unos cuantos otros. Necesito mencionarlos antes de que pueda explicar qué es el Versionamiento Semántico.&lt;/p>
&lt;h3 id="problema-uno-esto-tiene-un-bug">Problema Uno: &amp;ldquo;¡Esto tiene un bug!&amp;rdquo;&lt;/h3>
&lt;p>Supongamos que, usando el gestor de dependencias, obtengo una librería de abstracción del sistema de archivos, que me permite usar diversos adaptadores para distintos sistemas de archivo. Y supongamos que luego de un rato de usarla en mi código, descubro que tiene un bug de algún tipo.&lt;/p>
&lt;p>Dada esta situación, necesito dos cosas. Primero, notificar al autor de la librería sobre el bug encontrado; y segundo, esperar que él/ella lo solucione para que yo pueda incluir este fix en mi propio código.&lt;/p>
&lt;p>Por supuesto, podría entrar al vendor y arreglar el bug yo mismo. Pero te darás cuenta que modificar código de terceros en tu proyecto no sólo es una pésima práctica, sino una pésima idea; sobretodo si planeas hacer algún tipo de CI/CD o si trabajas con otras personas. Mejor, que esa idea ni se te pase por la cabeza.&lt;/p>
&lt;h3 id="problema-dos-podría-necesitar-esta-nueva-funcionalidad">Problema Dos: “¡Podría necesitar esta nueva funcionalidad!”&lt;/h3>
&lt;p>No sólo necesitamos bugfixes o mejoras de seguridad en nuestro código, sino también nuevas funcionalidades. Supongamos que la librería que estoy usando sacó un nuevo adaptador para conectarme a un sistema de archivos por FTP y decido probarla. Necesito ser capaz de recibir este cambio también en el código.&lt;/p>
&lt;p>Por supuesto, podría ser que el autor de la librería diseñó esta nueva funcionalidad, pero yo no la estoy usando. De todas maneras, no hay problema añadiendo cosas mientras no modifiques lo que ya existe.&lt;/p>
&lt;h3 id="problema-tres-no-lo-cambies-por-favor">Problema Tres: “¡No lo cambies por favor!”&lt;/h3>
&lt;p>Ahora, supongamos que el autor de esta librería hará un rediseño completo de la misma: cambiará interfaces y apis, movera/renombrará clases y quitará algunas cosas de las cuales dependíamos. Ahora el asunto se complica bastante para nosotros: si hay un método que tiene otro nombre o una clase que estabamos usando, si actualizamos la librería nuestro código se romperá. No queremos eso, hasta que no tengamos claro que sabemos como actualizar nuestro código para usar la nueva versión.&lt;/p>
&lt;h2 id="versionamiento-semántico-al-rescate">¡Versionamiento Semántico al Rescate!&lt;/h2>
&lt;p>Entonces, dados estos problemas, tenemos tres tipos de cambios en el software: &lt;strong>cambios que siempre quiero tener&lt;/strong> (bugfixes y mejoras de seguridad), &lt;strong>cambios que sería bueno tener pero que son totalmente opcionales&lt;/strong> (nuevas funcionalidades) y &lt;strong>cambios que definitivamente no quiero tener&lt;/strong> (cambios de api, renombramiento de una clase, etćetera).&lt;/p>
&lt;p>Es aquí donde SemVer brilla. Básicamente, lo que hace es indicar qué tipo de cambio se ha efectuado en un codebase mediante el uso de un sistema de tres números. Ej: 1.4.7&lt;/p>
&lt;p>El número de más a la derecha se le conoce como &lt;strong>patch&lt;/strong>, y se incrementa cada vez que hay un cambio en el código que arregla uno o varios bugs o implementa una o más mejoras de seguridad.&lt;/p>
&lt;p>El número del medio se conoce como &lt;strong>minor&lt;/strong>, y se incrementa en uno cada vez que a un release que contiene una nueva funcionalidad o mejora. Es importante que esta mejora no quite nada de lo que ya existe. Por ejemplo, puedes añadir métodos a una clase, pero no quitar un método o renombrar uno existente.&lt;/p>
&lt;p>El número de más a la izquiera se conoce como &lt;strong>major&lt;/strong>, y se incrementa en uno cada vez que hay un cambio que modifica lo que ya existe, efectivamente rompiendo el contrato de funcionamiento.&lt;/p>
&lt;h2 id="usando-semver">Usando SemVer&lt;/h2>
&lt;p>Usando estos números, podemos inteligente y confiadamente recibir mejoras y arreglos de bugs en el código de terceros que usamos, asegurándonos que no recibimos nuevas versiones &lt;strong>major&lt;/strong> que remperían nuestro código.&lt;/p>
&lt;p>La teoría de SemVer dice que, por ejemplo, si estoy usando la versión 1.0.4 de cierta librería, y quiero actualizar a la 1.6.0, es perfectamente posible y no debo preocuparme al respecto ya que no se rompería nada. No así, si quiero pasar a la versión 2.0.0. Esto me está indicando que hay un cambio que podría romper mi código. Todos los gestores de dependencias cuentan con el operador ^, que solo permite cambios de versiones &lt;strong>minor&lt;/strong> y &lt;strong>patch&lt;/strong>, pero no &lt;strong>major&lt;/strong>. Es una excelente práctica usarlos.&lt;/p>
&lt;p>Lo que hace la mayoría de la gente es que usan muy mal SemVer: especifican una versión exacta, como 1.6.0, pero con ello se pierden todas las mejoras de seguridad y nuevas funcionalidades. En PHP, incluso, he visto a personas requiriendo versiones &lt;code>dev-master&lt;/code>. No hagas eso nunca.&lt;/p>
&lt;h2 id="evaluando-librerías-de-acuerdo-a-semver">Evaluando librerías de acuerdo a SemVer&lt;/h2>
&lt;p>¿Dónde nos deja esto? Podemos razonar que librerías que tienen un corto periodo de vida pero un número de versiones &lt;strong>major&lt;/strong> grande (superior a 4 o 5), no son librerías maduras, sino librerías muy inestables y agresivas, que siempre están rompiendo su api. Por otro lado, librerías que llevan mucho tiempo en su versión &lt;strong>major&lt;/strong> (1 o 2) son estables y confiables, debido a que han demostrado no cambiar mucho y ser conservadoras en cuanto a su política de cambios.&lt;/p>
&lt;p>Nunca es bueno confiar en librerías muy agresivas. En PHP aprendimos la lección cuando ocurrió el problema de Guzzle. El tiempo que pasó de Guzzle 4 a Guzzle 6 fue tan corto, que como muchas librerías dependían de Guzzle 4, las que usaban Guzzle 6 no podían instalarse, causando problemas de dependencias bastante molestos en el ecosistema de PHP. Esto incluso motivó la creación de HTTPlug como abstracción sobre Guzzle, para evitar este tipo de problemas.&lt;/p></content></item></channel></rss>